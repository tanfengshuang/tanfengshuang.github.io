---
layout: post
title:  "管理网络(110-6)"
categories: Linux
tags: RHCA 110
---

### 管理网络和子网

###### IPv4 网络

TCP/IP 标准遵循 RFC1122 中指定的四层网络模型。

*    应用： 每一应用程序具有用于通信的规范，以便客户端和服务器可以跨平台通信。常用的协议有 SSH（远程登录）、HTTPS（安全 Web）、NFS 或 CIFS（文件共享），以及 SMTP（电子邮件递送）等。
*    传输： 传输协议有 TCP 和 UDP。TCP 是可靠连接导向型通信，而 UDP 属于无连接数据报协议。应用协议使用 TCP 或 UDP 端口。/etc/services 文件中可以找到常用的和已注册的端口列表。当数据包在网络上发送时，服务端口和 IP 地址组合形成套接字。每个数据包具有一个源套接字和目标套接字。此信息可以在监控和过滤时使用。
*    互联网： 互联网或网络层将数据从源主机传送到目标主机。每一主机具有 IP 地址和前缀，用于确定网络地址。路由器用于连接网络。ICMP 是这一层中的控制协议。它没有端口，而是使用类型。例如，ping 实用工具使用 ICMP 数据包测试连接。ping 发送 ICMP ECHO_REQUEST 数据包。ping 成功时会收到 ICMP ECHO_REPLY 确认。ping 不成功时可能会收到 ICMP 错误消息（如“无法到达目标”），或者收不到任何回复。
*    链路： 链路或介质存取层提供与物理介质的连接。最常见的网络类型是有线以太网 (802.3) 和无线局域网 (802.11)。每一物理设备具有一个硬件地址 (MAC)，用于标识局域网络段中数据包的目的地。

###### IPv4 地址

IPv4 地址是一个 32 位数字，通常使用点号分隔的四个十进制八位字节（取值范围从 0 到 255）表示。该类地址分为两个部分：网络部分和主机部分。位于同一子网中的所有主机可以在彼此之间直接通信，无需路由器，这些主机具有相同的网络部分。网络部分用于标识子网。同一子网中的任何两台主机都不能具有相同的主机部分。主机部分用于标识子网中的特定主机。

在现代互联网中，IPv4 子网的大小是可变的。要分清 IPv4 地址中的网络部分和主机部分，管理员必须知道分配给子网的子网掩码。子网掩码指明有多少位的 IPv4 地址属于子网。可供主机部分使用的位数越多，子网中的主机就越多。

有时，将子网中可能达到的最低地址（主机部分的二进制值全为零）称为网络地址。在 IPv4 中，子网中可能达到的最高地址（主机部分的二进制值全为一）用于广播消息，该地址称为广播地址。

子网掩码可用两种格式表示。较早的子网掩码语法中对网络部分使用 24 位，即 255.255.255.0。较新的语法称为 CIDR 表示法，它指定了一个网络前缀 /24。两种格式都传达同样的信息，即 IP 地址中有多少前导位组成其网络地址。


###### OpenStack 中的子网

实例分配到子网中，以允许网络连接。为预先存在的网络配置子网。每一项目有一个或多个子网。这使得使用同一网络的不同系统之间能有所区隔。

###### OpenStack 网络

OpenStack 网络是一种虚拟网络服务，旨在为在 OpenStack 环境中定义网络连接和寻址提供丰富的接口。它通过提供插件，让管理员享有所需的灵活度，以利用不同的联网技术和策略。在 Red Hat OpenStack Platform 中，OpenStack 网络服务是默认的网络选项。Nova 网络服务作为备选方式提供。

管理员可以创建和配置网络和子网，再指示 OpenStack Nova 计算等其他 OpenStack 服务将虚拟设备连接到这些网络上的端口，从而配置丰富的网络拓扑。尤其是，OpenStack 网络支持每个租户拥有多个专用网络，并且允许租户选择自己的 IP 寻址方案，即使这些 IP 地址与其他租户所用的相重叠也无妨。这可实现高级的云网络使用情景，如构建多层 Web 应用，允许应用不必更改 IP 地址就迁移到云端等。

原始 OpenStack Nova 网络实施假定基本的网络模型，其中所有网络隔离都通过利用 Linux VLAN 和 IP 表来执行。OpenStack 网络使用插件的理念，插件是 OpenStack 网络 API 的可插拔后端实施。插件使用多种技术来实施逻辑 API 请求。一些 OpenStack 网络插件可能使用基本的 Linux VLAN 和 IP 表，另一些或许采用 L2-in-L3 隧道或 OpenFlow 等更为高级的技术来提供相似的优点。

###### 项目/租户网络

项目拥有自己的网络，由 OpenStack 服务 Neutron 提供。这些网络使用 VLAN 隔离（每个项目网络是一个网络 VLAN）。也可以使用 VXLAN 或 GRE 进行隧道连接。每个项目网络包含一个 IP 子网，其网络流量被隔离在该项目中。

###### 外部网络

入站网络流量使用外部网络到达实例。外部网络使用分配给实例的 IP 地址，以及与实例关联的浮动 IP 来实现连接。OpenStack Horizon 控制面板和公共 API 驻留在外部网络上。

###### 提供商网络

实例通过提供商网络连接到现有网络。顾名思义，提供商网络使用扁平网络或 vlan 标记直接映射到预先存在的物理基础架构。这使得外部系统和 OpenStack 实例能够共享同一个第 2 层网络。

###### 网络命名空间

红帽 OpenStack 存储库提供的 kernel 包含网络命名空间。网络命名空间通过虚拟化对端口和接口等网络资源的访问，覆盖具有抽象层的网络访问。ifconfig 和 ip 命令不能显示这些命名空间中的 IP 地址。iproute 命令也已更新，允许查询这些命名空间。要访问命名空间，请使用 ip netns 命令并使用路由器的 UUID。本课程的后续章节中将深入探讨这些命令。

###### 创建实例的 Neutron 工作流程

    一旦在现有子网中创建了实例，Nova 计算服务会将请求发送到 neutron-server 服务，此服务运行 Neutron API。Neutron 服务器随后请求创建一个 IP 地址。此请求将由 Neutron DHCP 代理来管理，此代理查询与实例必须放入的子网相关联的 dnsmasq 的实例。dnsmasq 服务将范围内的第一个可用 IP 地址返回到 Neutron DHCP 代理，以便其将此 IP 地址发送回 Neutron 服务器。

    由于 IP 地址已分配给新实例，因此 Neutron 服务器将请求 Open vSwitch 创建所有必需配置以将新实例插入到现有子网中（使用先前分配的 IP 地址）。将使用 RabbitMQ 服务将此配置发送回 Neutron 服务器，并且 Neutron 服务器将其发送回 Nova 计算服务。

###### 创建网络

在 OpenStack 中创建网络后，实例便可通过 DHCP 接收正确的寻址并进行通信。对外部网络或物理网络的集成使得 OpenStack 之外的系统能够与实例通信。在创建网络之前，务必要考虑将要使用的子网是什么。网络可以托管多个子网，从而在同一网络中托管不同的系统并实现完全隔离。路由器用于将一个子网中的流量定向到另一个子网中。

使用 Horizon 创建网络

1. 在控制面板中，选择项目 -> 网络。
2. 单击创建网络。
3. 填写文本字段，再单击创建网络。

###### 删除网络

无论是出于开发、扩展还是调配的需要，在某一个时点上可能必须要删除某一网络。如果网络尚未连接到路由器，也没用于实例，那么从 Horizon 删除该网络很简单，只需前往Project > Network > Networks、选择网络再单击删除便可。但是，如果网络已连接了某一实例的路由器，则必须运用下列步骤。

删除用于某一实例的网络

1. 分离路由器接口。
2. 分离外部网关。
3. 将路由器从网络分离。
4. 删除网络。


### 验证外部网络功能

###### 外部网络

实例的互联网访问由外部网络提供。默认情况下，这种类型的网络仅允许使用网络地址转换 (NAT) 从实例访问互联网。借助安全组规则和浮动 IP，可以实现从互联网访问个别实例。外部网络为多个项目提供外部网络访问，严格归 admin 项目所有。因此，只有具有管理特权的帐户才能将网络设置为外部。外部网络要求分配有子网。与网络节点外部接口连接的物理网络所关联的子网和网关不和外部网络共享。最好是将某一部分的子网用于路由器和浮动 IP 地址，从而防止和外部网络上的其他设备产生干扰。Neutron L3 代理为项目网络上虚拟机的外部网络访问提供 L3/NAT 转发。


### 管理路由器

不管使用 IPv4 还是 IPv6，网络通信都需要以主机到主机和网络到网络的形式进行传输。每一主机具有一个路由表，该表告诉主机如何路由特定网络的通信。路由表条目将列出目标网络、向其发送通信的接口，以及任何中间路由器的 IP 地址（用于将消息中继到最终目的地）。与网络通信目的地相符的路由表条目用于路由该通信。如果两个条目匹配，则使用前缀最长的那一个。

如果网络通信匹配不到更加具体的路由，则路由表通常拥有一个路由到整个 IPv4 互联网的默认路由条目，0.0.0.0/0。这一默认路由指向一个可到达的子网（即在主机的路由表中拥有更加具体的路由的子网）上的路由器。

如果路由器收到的通信并非将其作为寻址目标，则路由器不会像普通主机那样忽略该通信，而是根据自己的路由表转发该通信。这种处理方式可能会将通信直接发送到目标主机（如果路由器恰巧与目标位于同一子网中），也可能转发到其他路由器。这种转发过程会一直进行，直到通信到达最终目标。

###### OpenStack qrouter

若要让实例与任何外部子网通信，必须部署路由器。Red Hat OpenStack Platform 通过使用 SDN（软件定义型网络） 型虚拟路由器来提供路由。与物理路由器类似，SDN 型虚拟路由器要求每个实例一个子网。路由器收到的流量将路由器的默认网关用作下一个跃点。默认网关使用虚拟网桥将流量路由到外部网络。每一路由器有许多接口与子网连接，一个网关连接一个网络。

创建路由器
1. 在 Horizon 中，选择项目 > 网络 > 路由器，再单击创建路由器。
2. 输入适用的描述。
3. 选择 Set Gateway。
4. 从 External Network 列表中选择要使用的网络。

###### 路由器接口

路由器和子网通过接口相连。这使得 SDN（软件定义型网络） 虚拟路由器能够将来自实例的流量路由到其他子网。

添加路由器接口
1. 在 Horizon 中，选择项目 > 网络 > 路由器，再单击具体的路由器。
2. 输入适用的描述。
3. 从下拉菜单中选择子网。
4. 单击 Add Interface。

###### 删除路由器

无论是出于维护、调配或者基本“家务”工作之需，需要删除路由器。只要没有接口与之连接，便可将路由器删除。如果连接了接口，则必须先删除接口后，才能删除路由器。否则会导致从 Horizon 收到错误。

删除路由器
1. 在 Horizon 中，选择 Project > Network > Routers ，再单击具体的路由器。
2. 选择内部接口，再单击删除接口。
3. 从下拉菜单中选择子网。
4. 在路由器列表中，选择路由器，再单击删除路由器。

###### DHCP 请求

高级 DHCP 请求流
1. 数据包从运行于 serverb 的实例出发，离开出站 eth0 并到达集成网桥 br-int。
2. 数据包从 br-int.转发到隧道网桥 br-tun。
3. 从 br-tun，数据包被封装，然后通过 vxlan 隧道进入 servera。
4. 到达 servera 上 vxlan 隧道的 Neutron 网络主机一侧后，封装将被移除。
5. 数据包而后转发到 br-int，数据包被封装并通过 vxlan 隧道进入 servera。
6. servera 上的 br-int 与 qDHCP 命名空间相连，后者运行了 dnsmasq 进程。
7. DHCP 请求现在被接受。


### 验证 OpenStack 网络功能

###### ICMP 回显请求

网络故障排除中最基本也最常用的一个实用工具是 ping 命令。ping 命令 ICMP 回显请求和回显回复消息。使用 ping 可以确认 IP 数据包能够到达目的地 IP 地址并返回。ping 返回两项宝贵的信息，即连通性和 RTT（往返时间）。连通性的最简单形式体现在是否能从原点到达终点（根据推理，反向亦可）。RTT（往返时间）用作在许多方面进行比较的指标，如所用的硬件，它们可以影响返回流量的用时。

在下例中，虚拟机 vm-alpha 存在连通性问题。执行下列故障排除步骤。

1. WWW -- 验证 ping 是否能成功到达 OpenStack 环境以外的 URL。

*    成功 -- 这说明从运行命令的系统发出的数据包能够正常穿过数据包抵达外部目的地的所有跃点。
*    失败 -- 如果测试失败，则从环境中的另一个系统（在接入互联网上通常没有问题）执行相同的测试。如果该测试成功，则表明问题不在于互联网，而在与数据包通向互联网的路径上所经过的跃点或目的地之间的连通性。

2. Physical Router -- 根据具体的部署，物理路由器或第 3 层交换机将数据包路由到外部目的地。

*    成功 -- 成功 Pinging 默认网关表示，从 ping 命令的起点到路由器接口以及该路径上的每一网络设备没有连通性问题。
*    失败 -- 这表示存在与通往默认网关的路径上一个或多个网络设备相关或者与提供该网关的路由器接口本身的连通性问题。

3. Virtual Router -- 用于路由虚拟机流量的 SDN 型路由器。

*    成功 -- 成功 Pinging 虚拟路由器表示，路由器配置正确并且数据包没有被任何防火墙规则拦截。
*    失败 - 这表示可能存在一些问题。允许和拒绝流量的安全组的配置可能不正确，或者一个或多个必需的服务可能已终止或者没有启动。

4. Physical Switches -- 物理交换机管理同一网络上的系统之间的网络流量。

*    成功 -- 虚拟机发送的数据包穿过虚拟网络基础架构到达其目的地。如果 ping 成功，则表明：流量穿过虚拟网络基础架构没有任何问题，交换机端口上也没有连接相关的问题。
*    失败 -- 这表示虚拟网络基础架构存在问题，或者一个/多个物理交换机端口配置错误。

5. Virtual Machine -- Ping 驻留于同一子网上的另一个虚拟机

*    成功-- vm-alpha 的虚拟硬件和网络配置都正确。


Open vSwitch 配置

*    br-int 	为实例流量提供入站和出站 VLAN 标记
*    br-ex 	    提供外部网桥并通过 TAP 设备连接到 qrouter 的 qg
*    qg 	    将路由器连接到网关
*    qr 	    将路由器与集成网桥 br-int 连接
*    qvo 	    连接到集成网桥
*    qvb 	    通过 qvo 将防火墙网桥连接到 br-int
*    qbr 	    提供 OpenStack 安全组的 Linux 网桥


### 总结

在本章中，您可以学到：

*    要让实例使用网络，必须配置 OpenStack 网络：首先创建路由器，然后创建网络和子网。
*    OpenStack 网络是一种虚拟网络服务，旨在为在 OpenStack 环境中定义网络连接和寻址提供丰富的接口。
*    红帽 OpenStack 存储库提供的内核包括网络名称空间，它们通过虚拟化对网络资源（如端口和接口）的访问权限，从而涵盖具备抽象层的网络访问。
*    ping 命令用途广泛，不仅可用于故障排除，也能用于验证端到端连通性。
