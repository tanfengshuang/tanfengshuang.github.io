---
layout: post
title:  "管理安全性和访问权限(110-9)"
categories: Linux
tags: RHCA 110
---

### 管理密钥对

###### 管理密钥对

SSH 密钥是一种不使用密码、通过 SSH 协议连接远程服务器的安全、可信的方式。SSH 密钥始终成对出现，即一个私钥和一个公钥。在 Linux 系统上，私钥通常存储在 ~/.ssh/id_KEY TYPE 下，而公钥则存储在 ~/.ssh/id_KEY TYPE.pub 下，其中 KEY TYPE 是加密算法，如 RSA 或 DSA。最常用的默认加密类型是 RSA，所以密钥的名称将是 id_rsa 和 id_rsa.pub。公钥可以自由共享或发送到远程服务器（在 ~/.ssh/authorized_keys 文件中），而私钥则应在本地计算机上通过严格的访问规则来加以保护。

SSH 密钥可以被视为锁和钥匙。公共部分是锁，可以复制到多个位置，前提是私有部分（或者钥匙）未遭破坏。由于私钥可以通过密码进行保护，这就类似于把实际钥匙放在保险箱中。SSH 密钥的使用原理如下：
1. 假设密钥已通过密码进行保护，打开密语来获取私钥。
2. 然后使用私钥打开公钥，将访问权限授予持有公钥的远程系统。当远程服务器看到连接请求时，它使用公钥来构建和发送质询。此质询是一条加密的消息，必须以适当的应答加以匹配，然后服务器才会授予访问权限。

由于生成密钥时所用加密的性质（SSH 密钥生成加密的核心所在），该质询几乎不可能被解密或拦截。主要的风险是未经授权访问密钥对的私有部分，或者因为密钥大小不足而导致密钥被破译。

此外，用户无法更新私钥或公钥，因为它们在生成时都使用了会产生长串随机数字的密码。这也意味着，用户一旦丢失私钥或公钥，便无法恢复，唯一的解决办法是将它们删除并重新创建。

OpenStack 为用户提供生成密钥对和导入现有密钥对的功能；生成后的公钥存储在数据库中，而私钥则不存储，因为访问数据库将破坏私钥的完整性以及安全性。

生成密钥对后，用户便可将它用于实例来进行连接。导入公钥后，Nova 会将它存储在自己的数据库中，并且要求用户持有该公钥所依赖的私钥。根据映像的配置方式，若无密钥对，可能无法连接实例。

> 密钥对一旦删除，便无法恢复。在删除之前，确保没有任何运行中的实例依赖于此密钥对。

###### 访问实例

若要让用户能够通过密钥对进行连接，实例必须已配置为支持此类系统。该配置在模板创建过程中完成，该过程包括：

1. 确保 SSH 服务器已经安装（通常由 openssh-server 软件包提供），并配置为支持 SSH 密钥身份验证。
2. 确保实例可由 Nova 配置，它会将公钥注入到实例中。此类操作依赖于旨在执行云配置的 cloud-init 软件，如自定义主机名、创建用户和注入 SSH 公钥等。

生成实例时，需要在创建服务器期间使用 --key-name KEY NAME 标志指定密钥，其中 KEY NAME 是已创建的密钥对的名称。然后，用户可以使用其私钥发起对实例的 SSH 连接。

> 如果丢失私钥或公钥，用户只能重新创建密钥对。如果远程系统阻止密码身份验证，则恢复连接的唯一方式是通过控制台连接并安装新的密钥。如果密码未知且 root 访问权限被禁用（cloud-init 不禁用 root 访问权限），则用户只能以救援模式重新启动，或者终止实例并重新生成一个。因此，建议将密钥备份到安全的地方。

> 默认情况下，大多数供红帽 OpenStack 平台使用的映像配置为仅限以 cloud-user 用户身份进行基于 SSH 密钥的访问。


### 管理安全组

###### 安全组

OpenStack 利用安全组来提供来自实例和对实例的访问控制。安全组是高级访问控制规则，定义哪些网络或协议有权访问实例。安全组由 IP 过滤规则组成，这些规则应用于实例的网络。它们特定于项目，项目成员可以编辑安全组的默认规则，也可添加新的规则集。所有项目都预先创建有 default 安全组，它应用到未定义其他安全组的实例。

> 除非经过更改，否则此默认安全组拒绝所有传入的流量，但来自 default 安全组内部署的实例的流量除外。

当前项目的安全组可以在 OpenStack 控制面板的访问权限与安全选项卡下找到。要查看现有安全组的详细信息，管理员要选择针对该安全组的编辑操作。从此界面中，也可对现有的安全组进行修改；访问权限与安全主选项卡上的创建安全组按钮可用于创建新安全组。 

###### 安全组术语

*    术语 	    定义
*    安全组 	    安全组是特定于项目的群组，其包含的规则用于管理进出 OpenStack 实例的传入和传出流量。
*    安全组规则 	每条安全规则定义应当如何处理网络。规则定义协议是要允许还是阻止，也定义网络是要授权还是阻止访问实例。
*    规则方向 	规则方向定义要应用安全组规则的方向。有效的规则是 ingress 或 egress。
*    远程 IP 	此选项将指定的 IP 前缀与要过滤的 IP 数据包的来源 IP 地址匹配。
*    协议 	    此选项定义安全组规则要匹配的网络协议。有效的值为 null、TCP、UDP 和 ICMP。
*    端口 	    此选项定义安全组规则要匹配的网络端口。根据规则所使用的协议，端口或有不同。
*    以太网类型 	此选项定义安全组规则要匹配的协议；它必须是 IPv4 或 IPv6，并且以 CIDR 表示的地址必须匹配入站或出站规则。

添加新安全组时，操作员应当为安全组选取一个描述性名称。此名称将显示在使用该安全组的实例的简短描述中，而较长的描述字段中通常不会。此外，其描述也应指出安全组所过滤的流量；这样做可有助于故障排除。

###### 定义安全组

管理员可以使用 OpenStack 命令行界面或 Horizon 控制面板定义新的安全组以及关联的规则。在创建规则之前，需要先定义安全组，因为规则将添加到组中：组本身不执行过滤，它只是安全规则的逻辑重新分组。OpenStack 使用 Nova 和 Neutron 来管理安全组和安全组规则。两者均调用 Netfilter，它是 Linux 内核提供的框架，允许以规则的形式实施联网相关的操作。Netfilter 分析和检查数据包，从而确定如何处理它们；它使用用户定义的规则在网络堆栈中路由数据包。

> 虽然 nova-network 过去提供了安全规则的支持，但 Neutron 现在是管理安全规则实施的服务。

操作员可以将安全组用于：

*    定义使用者可以访问的服务，并且阻止未经授权的访问。
*    限制被授权访问实例的远程网络。这在分阶段环境中很有用。
*    通过指定每个组的过滤，进一步过滤同一网络中租户或实例间的访问。

两个或多个安全组之间的流量可以通过定义来源组来控制。此类规则可用于阻止同一项目中的实例访问其他实例。

> 移除安全组时，关联的所有规则也会被移除。

> 创建或移除安全规则时，它会立即生效。


### 验证密钥对和安全组功能

###### 验证密钥对

为确保密钥已正确注入到实例中，操作员可以通过向实例发起 SSH 连接来测试连通性。使用 ssh 命令进行连接时，操作员可以通过 -i 标志指定用于连接的私钥：

```
# ssh -i PRIVATE KEY cloud-user@IP
``` 

当 cloud-init 注入了公钥后，操作员便可使用对应的私钥。

> 如果在 cloud-init 自定义实例时没有选择密钥，操作员将无法通过 SSH 连接到实例，因为它将关闭密码身份验证。实例将需要终结并重新创建。

###### 验证安全组

实例启动并连接到安全组后，Neutron 会即时创建安全规则。安全规则通过 Netfilter 的 iptables 命令创建。该命令用于创建规则，内核针对与实例往来的每个数据包读取规则并进行处理。要验证安全组是否已正确应用，用户可以尝试访问实例上运行的、安全规则拒绝其访问的服务。例如，用户可以尝试通过端口 80 访问已启动且在运行中的 Web 服务器，而有一条显式规则阻止进入端口 80 的传入流量。


### 总结

在本章中，您可以学到：

*    SSH 密钥是一种不使用密码、通过 SSH 协议连接远程服务器的安全、可信的方式。
*    OpenStack 为用户提供生成密钥对和导入现有密钥对的功能；生成后的公钥存储在数据库中，而私钥则不存储，因为访问数据库将破坏私钥的完整性以及安全性。
*    生成实例时，需要在创建服务器期间使用 --key-name KEY NAME 标志指定密钥，其中 KEY NAME 是已创建的密钥对的名称。
*    OpenStack 利用安全组来提供来自实例和对实例的访问控制。安全组是高级访问控制规则，定义哪些网络或协议有权访问实例。
*    OpenStack 支持通过 SSH 密钥访问其中部署的实例，公钥由 OpenStack 注入到实例中（通常以 cloud-user 用户身份） 
