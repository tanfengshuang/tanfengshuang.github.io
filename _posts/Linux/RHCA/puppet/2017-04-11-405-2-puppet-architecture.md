---
layout: post
title:  "Puppet Architecture(405-2)"
categories: Linux
tags: RHCA 405
---


### Puppet 架构

###### 什么是 Puppet？

Puppet 是一款开源配置管理软件。Puppet 允许系统管理员编写基础架构即代码，利用描述性语言配置计算机，而不使用个别化的自定义脚本来执行。Puppet 域特定语言 (DSL) 用于描述计算机的状态，并且 Puppet 可以强制执行这一状态。这意味着，如果管理员错误地更改了计算机上的内容，Puppet 可以强制执行状态并将计算机恢复为所需的状态。因此，Puppet 代码不仅可用于对系统进行初始配置，也可用于使系统的状态与所需配置保持一致。

传统的系统管理员可能需要登录每一台计算机来执行系统管理任务，但这样不能良好地扩展。系统管理员或可为计算机创建一个初始配置脚本（如 Kickstart 文件），但在运行了该初始化脚本后，计算机可能（也会）开始偏离该初始化脚本配置。在最理想的情景中，系统管理员需要定期检查计算机以验证配置。在最糟糕的情景中，系统管理员需要查明计算机不再正常工作的原因，或者重新构建计算机并重新部署配置。

Puppet 可用于设置所需的状态，并使计算机收敛于该状态。系统管理员不再需要将一个脚本用于初始配置，并使用另一个单独脚本（或更糟糕的情形中通过人工干预）验证状态。Puppet 可以管理系统配置并验证系统处于所需的状态。相较于传统系统管理员将单独的脚本用于各个系统，这种方式能够更好地扩展。

###### Puppet 架构

Puppet 使用服务器/客户端模型。服务器称为 Puppet 宿主。Puppet 宿主存储客户端的配方或清单（包含资源和所需状态的代码）。客户端称为 Puppet 节点并运行 Puppet 代理软件。这些节点通常运行用于连接 Puppet 宿主的 Puppet 守护进程 (agent)。节点将下载从 Puppet 宿主分配到该节点的配方，再根据需要应用配置。 

Puppet 运行从 Puppet 节点（而非 Puppet 宿主）启动。默认情况下，Puppet 代理每 30 分钟启动一次 Puppet 运行。此运行利用安全传输 (SSL) 服务在 Puppet 节点和宿主之间来回传递数据。节点首先利用 facter 命令收集系统的相关事实。Facter 包含块设备、文件系统、网络接口、Mac 地址、IP 地址、内存、操作系统、CPU 和虚拟化等信息。这些事实从节点发送到宿主。

一旦 Puppet 宿主收到来自 Puppet 节点的事实，Puppet 宿主将编译目录；目录描述为节点配置的各种资源的所需状态。Puppet 宿主检查节点的主机名，再将它与特定的节点配置（称为节点分类）匹配，或使用默认的配置（如果节点不匹配）。此目录可能包含资源的依赖项信息（例如，Puppet 应当先安装软件包，还是先启动服务？）。

编译了目录后，Puppet 宿主将目录发送到节点。Puppet 然后在 Puppet 节点上应用目录，配置目录中定义的所有资源。Puppet 是幂等的；Puppet 可以将目录多次应用到一个节点，而不会影响最终的状态。本课程的后续部分将探讨幂等性。

通过 Puppet 代理将目录应用到节点后，该节点会向 Puppet 宿主回报运行详情。报告中包含关于对节点进行了什么更改（若有）和运行是否成功完成的信息。Puppet 报告基础架构提供了 API，因此其他应用可以从 Puppet 宿主下载报告以进行存储或深入分析。


###### Puppet 可以管理什么？

借助预定义的资源类型，Puppet 语言可用于描述系统的所需状态。对于系统管理员而言，这些资源比较直观明了。例如，user 资源用于配置用户，而 package 资源则用于配置软件包。稍后将更加详细地探讨资源和 Puppet 域特定语言；不过，以下代码片段演示了某一简单的 DSL 代码。

```
user { 'notauser':
  ensure => 'absent',
}
```

以上代码将确保系统上不存在名为 notauser 的用户。如果系统上没有 notauser 用户，Puppet 将回报成功。如果系统上存在 notauser 用户，Puppet 将运行必要的命令从系统中删除该用户（本例中为 userdel）。Puppet 可用于多种操作系统；因此，这同一代码可在其他受支持的操作系统上使用，而不必知晓用于删除用户帐户的实际命令。请注意，截至红帽卫星 6.1，卫星不支持在 Red Hat Enterprise Linux 以外的任何操作系统上运行 Puppet 代码。

```
file { '/var/www/html/index.html':
  ensure => 'file',
  owner  => 'root',
  group  => 'root',
  mode   => '0640',
}
```

以上代码将确保系统上存在名为 /var/www/html/index.html 的文件。所有者和组是 root，并且模式为 640。尽管这一简单代码片段中未予以展示，但 Puppet DSL 除了管理文件所有权和权限，也可以管理文件内容。

```
package { 'httpd':
  ensure => 'installed',
}
```

以上代码将确保系统上安装了 httpd 软件包。

```
service { 'httpd':
  ensure => 'running',
  enable => true,
}
```

以上代码将确保系统上启动并且启用了 httpd 服务。 


### Puppet 在企业环境中

###### Puppet 在 DevOps 环境中

Puppet 代理可以在企业环境中的许多位置上使用，如生产数据中心、开发人员的虚拟机、测试环境以及桌面等。在 DevOps 环境中，开发人员希望每天（或每小时）多次编写、测试并在生产中部署代码，Puppet 特别有用。Puppet 可以用于管理开发环境配置、安装和自定义软件，以及管理帐户，甚至还能用于拷贝代码的干净签出版。利用 Puppet，测试、质量保证 (QA) 或质量工程 (QE) 环境可以配置为与开发环境完全一样。实际上，组合使用 Vagrant 和 Puppet 是快速配置开发环境和测试环境的有效途径。通过一条简单的命令，Vagrant 构建虚拟机，而 Puppet 则针对所需的环境配置该虚拟机。当应用或代码通过了测试时，代码可以部署到生产中，这时代码能在合理程度上保证应用成功运行，特别是生产环境和测试环境使用相同的 Puppet 配置时。

在 DevOps 环境中使用 Puppet 时，需要确保一些事项：

*    Puppet 代理有权访问软件存储库。如果 Puppet 配置指定 package 资源管理软件包，则 Puppet 代理必须有权访问正确的软件存储库（如红帽卫星服务器或红帽订阅存储库）。
*    给予这些环境相同的配置。Puppet 可以为用于开发、测试和生产的计算机提供完全相同的配置。有时候，用于开发和测试环境的 Puppet 宿主会与生产环境中的 Puppet 宿主相互独立（例如，为了安全起见）。若是如此，请确保开发和测试用 Puppet 配置与生产用 Puppet 配置尽可能一致。
*    各 Puppet 代理应当连接至 Puppet 宿主。可以在本地存储 Puppet 配置并使配置管理具有自包含性，但这种方式将错失 Puppet 的一些益处，即代码重复利用和中央管理。Vagrant 可以配置为在运行时指定 Puppet 宿主。

在企业环境中，通常需要让关键服务在极少有停机时间的高可用性 (HA) 模式中运行。目前尚无法在 HA 模式中配置 Puppet，尽管有办法让 Puppet 宿主具有冗余或负载均衡能力。虽然其配置已超出本书范畴，但下表列举了有多个 Puppet 宿主可用时的一些选择：

*    静态设置 Puppet 宿主。环境中的一部分指向一个 Puppet 宿主，其他部分指向另一个 Puppet 宿主。如果一个 Puppet 宿主出现故障，Puppet 代理可手动将配置更改为指向其他 Puppet 宿主。
*    轮询 DNS。DNS 配置成向单一主机名提供不同 IP 地址。这可在多个 Puppet 宿主之间平衡负载，但如果某一 Puppet 宿主出现故障，Puppet 代理会遇到问题，直至进行了 DNS 更新为止。
*    负载平衡器。可以利用硬件或软件负载平衡器，智能地重定向来自 Puppet 代理的请求。
*    DNS SRV 记录。这是一项实验性功能，可在 DNS 中提供 Puppet 宿主池。

Puppet 软件提供两种变体：Puppet Enterprise (PE) 和 Puppet 开源版。与 Red Hat Enterprise Linux 从 Fedora 提取作为其上游来源非常相似，Puppet Enterprise 从 Puppet 开源版提取作为其上游来源。Puppet Enterprise 由 PuppetLabs 提供支持，但其上游来源不受支持。尽管红帽卫星使用的是开源版本的 Puppet，但红帽与 PuppetLabs 协作提供对红帽卫星内 Puppet 的支持。红帽卫星版本 6.1.1 提供与 Puppet Enterprise 的集成（通过 Puppet Forge）。 


### 有状态环境

###### 系统状态

Puppet 的描述性语言用于描述系统的状态。此类状态包括但不限于：

*    用户和组：管理系统上的用户和组。它们可以定义为存在或不存在。所有用户（ID、主目录和 shell 等）和组（ID 和用户等）的一般选项都可以由 Puppet 进行管理。
*    文件：所有权、模式，乃至内容都可以由 Puppet 进行管理。
*    软件包：管理已安装（或未安装）的软件包。Puppet 还可以管理安装的软件包版本。
*    服务：管理系统上的服务。其状态包括运行中、已停止、已启用或已停用。注意在处理服务前，该服务必须可用（已安装）。
*    主机：管理 /etc/hosts 文件中的条目。
*    SSH 密钥：管理 SSH 主机密钥和 SSH 授权密钥。

###### 幂等性

虽然可以使用 Puppet 运行任意命令，但通常建议不要这样做。Puppet 需要是幂等的；也就是说，无论起始状态为何，Puppet 运行后造成的最终状态应当始终都一样。请思考以下 Puppet 代码片段：

```
user { 'notauser':
  ensure => 'absent',
}
```

对于这段代码，在 Puppet 运行之前系统可能有两种常规状态：系统上存在用户 notauser，或者系统上不存在 notauser 用户。如果存在用户 notauser，Puppet 运行将删除该用户（利用 userdel）。如果不存在用户 notauser，则 Puppet 不执行任何操作。无论何种情形，Puppet 运行之后用户 notauser 都会消失。Puppet 代码可以运行多次，但最终结果都相同。

请思考以下命令。哪一条是幂等的？

```
[root@host ~]# echo '127.0.0.1 localhost' > /etc/hosts
[root@host ~]# echo '127.0.0.1 localhost' >> /etc/hosts
```

差别细微，但很重要。第一条命令（使用 >）是幂等的，始终会使 /etc/hosts 的最终结果包含一个 localhost 行。第二条命令（使用 >>）会追加内容至 /etc/hosts 文件，因此是非幂等的，因为文件将根据命令运行的次数而不同。在 Puppet 代码中使用 exec 时，请确保命令是幂等的。

###### Puppet 不能管理的对象

务必要清楚，Puppet 使用的是有状态语言，因此 Puppet 只能定义系统的最终状态。Puppet 不能做的事有许多，大部分是不能由其状态定义的项目。例如，是谁更改了某一文件？Puppet 可以确保文件具有特定的所有权，甚至是内容，但它不能跟踪谁更改了系统上的某样事物。Puppet 并不是审查系统；Puppet 仅确保系统的最终状态。下表列出了 Puppet 无法执行的其他项目示例。

*    确保安装期间包含某一软件包。这可以通过 Kickstart 来提供，Puppet 则不行。不过，当使用了 Puppet 时，就不再需要 Kickstart。每一系统可以从最小安装起步，再使用 Puppet 进行其余的配置。
*    Bob 为什么更改了此文件？他更改了文件中的什么内容？这些是版本控制系统也许能够解答的问题，而不是 Puppet 能够配置的结果状态。

###### Puppet 术语

下表提供了一些常见 Puppet 术语的定义。

*    术语 	描述
*    清单 	Puppet 代码文件。清单文件的名称通常以 .pp 结尾，文件内包含有 Puppet 代码。
*    模块 	Puppet 清单、文件和模板等的结构。模块分配到 Puppet 节点，并且管理该节点的配置。
*    目录 	编译的 Puppet 代码集合，应用到 Puppet 节点上。在 Puppet 运行期间，Puppet 宿主利用分配到 Puppet 节点的模块编译该节点的目录。目录应用到 Puppet 节点上，以确保状态。
*    资源 	系统中可由 Puppet 管理的一个方面。这包括文件、软件包、用户和组，以及服务。这是 Puppet 代码的基本单元。
*    Puppet 代理 	在 Puppet 客户端上运行的 Puppet 服务。默认情况下，Puppet 代理每 30 分钟运行一次。系统管理员可以随时运行 Puppet 代理。
*    Puppet 节点 	Puppet 客户端。
*    Puppet 宿主 	Puppet 服务器。Puppet 宿主也可以是其本身或其他 Puppet 宿主的 Puppet 节点。 


### 总结

在本章中，您学到了：

*    Puppet 使用客户端/服务器模型, Puppet 宿主是服务器，而 Puppet 节点是客户端。Puppet 节点运行 Puppet 代理。
*    Puppet 运行过程中，Puppet 代理首先在 Puppet 节点上收集事实。事实通过 SSL 发送到 Puppet 宿主。Puppet 宿主编译目录，并将目录发回到 Puppet 节点。Puppet 节点应用该目录，再发送报告到 Puppet 宿主。
*    Puppet 可以管理文件、软件包、用户、组和服务。
*    如果使用 package 资源，则 Puppet 节点需要有权访问软件存储库。
*    清单是包含 Puppet 代码的文件。模块包含清单、文件和模板。
*    幂等性是无论起点为何都能通过设置配置让系统状态保持相同状态的能力。 
