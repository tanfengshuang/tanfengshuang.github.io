---
layout: post
title:  "快速安装单机Openshift环境"
categories: Openshift
tags: openshift
---

### CL280实验环境介绍

*    启动CL280环境（RHEL7环境）
*    桌面图标介绍
*    实验环境虚拟机介绍
*    实验环境使用介绍

```
rht-vmctl
Manage VMs
View servera/serverb
```

*    实验环境网络172.25.0.0/16
*    三个虚拟机classroom servera(主机名server0-a, ip 172.25.0.10) serverb(主机名server0-b, ip 172.25.0.11)
*    软件包、安装脚本和其他实验所需要文件下载位置: http://classroom.example.com

### 快速安装单机Openshift环境

*    打开Vmware虚拟机
*    进入Foundation0
*    启动Server0-a虚拟机
*    通过SSH登录server0-a虚拟机
*    安装ruby
*    使用oo-install-ose安装openshift环境


### 快速安装Openshift环境

*    打开CL280虚拟机
*    进入CL280虚拟机系统
*    打开终端并重置servera试验机
*    等待servera试验机重置
*    通过SSH连接server0-a主机

```
# rht-vmctl reset servera
# rht-vmctl status all 
# rht-vmctl stop serverb
# rht-vmctl status all
```

*    安装自动化部署工具所需要的ruby包
*    创建自动化部署工具所需要的SSH密钥
*    不同密钥中的公钥到需要安装的主机

```
# yum install -y ruby
# ssh-keygen
# ssh-copy-id -i /root/.ssh/id_rsa.pub root@server0-a
```

*    下载自动化部署工具并将其解压
*    启动自动部署工具，并按应答部署openshift
*    漫长的等待开始了

```
# mkdir -p /root/oo-install
# wget -p /root/oo-install/ http://classroom.example.com/pub/materials/oo-install-ose.tgz
# cd /root/oo-install/
# tar zxvf oo-install-ose.tgz

# gunzip oo-install-ose.tgz     -> 如果有时候解压失败可以先gunzp，再tar
# tar xf oo-install-ose.tar

# ./oo-install-ose

# ls /tmp/openshift-deloy.log   -> 整个安装过程log

```


### 快速安装后的配置操作

*    查看自动生成的应答文件
*    修改demo用户的默认登录密码
*    关闭本地DNS解析
*    配置openshift使用远程DNS提交和解析动态域名
*    普通用户使用客户端创建应用
*    审计应用状态


###### 查看自动生成的应答文件

```
查看自动生成的应答文件 - oo-install-ose程序安装后会在/root/目录下的.openshift目录下生成一个yml应答文件
# more /root/.openshift/oo-install-cfg.yml

# cd /root/oo-install/
# ./oo-install-ose -h
-c, --config-file FILEPATH      -> 可以用这个应答文件来安装

```

###### 修改demo用户的默认登录密码

*    默认oo-install-ose安装中demo用户的密码是一个非常复杂的字符串
*    除非你希望使用那个字符串，一般都会修改
*    Openshift默认的认证是基于htpasswd的
*    认证配置文件是/etc/openshift/htpasswd

```
# cat /etc/openshift/htpasswd
demo:...
# htpasswd -b /etc/openshift/htpasswd demo redhat
# cat /etc/openshift/htpasswd   
demo:...        -> 加密的密码变了
```


###### 关闭本地DNS解析

*    oo-install-ose会配置本地Broker服务器的DNS作为动态域名解析服务器
*    servera主机上解析服务器被设置为优先使用本机DNS服务

```
# cat /etc/resolv.conf
# The named we install for our OpenShift PaaS must appear first
search apps0.example.com.
nameserver 172.25.0.10      -> servera主机上解析服务器被设置为优先使用本机DNS服务

; generated by /sbin/dhclient-script
nameserver 172.25.254.254

# service named stop
# chkconfig named off
```

###### 配置openshift使用远程DNS提交和解析动态域名


*    配置文件位置：/etc/openshift/plugins.d
*    配置文件名： openshift-origin-dns-nsupdate.conf

```
BIND_SERVER=动态更新DNS服务ip
BIND_PORT=动态更新DNS服务端口
BIND_ZONE=动态更新的基础域
BIND_KEYNAME=动态更新key信息名称
BIND_KEYVALUE=动态更新key信息内容
BIND_KEYALGORITHM=动态更新key加密方式
```

```
# cd  /etc/openshift/plugins.d
# ls
openshift-origin-admin-console.conf
openshift-origin-auth-remote-user.conf
openshift-origin-dns-nsupdate.conf          -> 只需要修改dns文件
openshift-origin-msg-broker-mcollective.conf

获得实验环境预创建的BIND_KEYVALUE
# wget http://classroom.example.com/pub/ddnskeys/kapps0.example.com*.key    -> 复制文件最后一部分

# vim openshift-origin-dns-nsupdate.conf          -> 更新为使用classroom为动态更新域名服务器
BIND_SERVER="172.25.254.254"
BIND_PORT="53"
BIND_ZONE="apps0.example.com"
BIND_KEYNAME="apps0.example.com"
BIND_KEYVALUE="前面复制出来的key字段"
BIND_KEYALGORITHM="HMAC-MD5"

# service restart openshift-broker restart

测试本地broker相关服务是否安装正常  -> 看到PASS说明正常
# oo-accept-broker -v   

测试本地node相关服务是否安装正常    -> 看到PASS说明正常
# oo-accept-node -v
```
