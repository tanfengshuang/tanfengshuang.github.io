---
layout: post
title:  "Creating RHEV Data Centers and Clusters(318-4)"
categories: Linux
tags: RHCA 318
---

### 创建数据中心

###### 数据中心

RHEV-M 配置中的顶级组织对象是数据中心（数据中心选项卡）。数据中心将所有物理资源和逻辑资源包含在一个托管的虚拟环境中。这可能是在某一特定地点特定物理数据中心的所有机器，它会与属于某一组织单元的系统和存储集保持一致，或者它会指示对管理器有意义的一些其他细分。系统会自动创建名为“默认”的数据中心。对于很多网站，可能没有理由在初始的默认数据中心之外再额外创建数据中心。

###### 网络容器

一个数据中心可以设置多个逻辑网络，以将节点间不同类型的流量隔离在不同网络中。通常情况下，此类隔离基于网络的物理拓扑和各种功能要求进行。例如，管理员可能要将来自 NFS 或 iSCSI 存储流量的数据流量分隔到访问虚拟机上网络服务的客户端。要执行此操作，管理员可以将该流量放置在不同的逻辑网络上。

逻辑网络可用 IP 地址和网络掩码分隔，因为可使用 VLAN ID 标记方法标识不同的网络流量。

###### 存储容器

每个数据中心都有一个关联的存储池。存储池是独立存储域的集合，这些存储域是物理主机共享的映像的中央存储库。基本存储域有三种：

*    数据域存储虚拟客户机映像（虚拟硬盘映像）和映像状态快照。数据域无法在数据中心之间共享。数据域可以基于 NFS、iSCSI 或光纤通道，然而目前对于特定数据中心中的主域，同一时间只能使用其中一种技术。
*    ISO 域存储用于虚拟机安装或救援的 ISO 映像（逻辑 CD-ROM 和 DVD-ROM）和 VFD（虚拟软驱映像）。ISO 域可在不同的数据中心之间共享。
*    导出域用来在数据中心和 RHEV-M 安装之间复制或移动映像。导出域还可以用于备份虚拟机。导出域可在数据中间之间移动，但一次只能在一个数据中心内为活动状态。

数据中心的一个主机会自动被选为存储池管理员或 SPM。此主机负责管理对通过 RHEV-M 通信的存储池的更改。所有主机均可更改存储域中的映像数据；但仅 SPM 可以更改存储域元数据。如果当前 SPM 主机发生故障，则 RHEV-M 会将 SPM 重新定位给其他主机。

SPM 必须运行才能添加存储域。这就是管理员在从零开始设置数据中心前必须注册主机（系统管理程序）的原因。完成此操作后，便可以开始配置存储域。

在 NFS 数据中心内，SPM 在常规文件系统顶端创建虚拟磁盘，作为用于精简资源调配（稀疏）格式的 QCOW2 磁盘，或作为预分配 (RAW) 格式的普通磁盘。在 iSCSI 或光纤通道中心内，SPM 在提供的逻辑单元号 (LUN) 顶端创建一个卷组 (VG)。

对于带有预分配格式的虚拟磁盘，将创建一个指定大小的逻辑卷 (LV)。对于精简资源调配格式的虚拟磁盘，首先一个创建 512 MB 的 LV。该 LV 一直由运行虚拟机的主机监视。一旦运用接近一个阈值，主机就将通知 SPM 和 SPM 再为 LV 扩展 512 MB。

从性能的角度看，预分配 (RAW) 格式的虚拟磁盘明显比精简资源调配 (QCOW2) 格式的虚拟磁盘快。建议精简用于非 IO 密集型虚拟桌面的配置格式和用于虚拟服务器的预分配 (RAW) 格式。

###### 重新初始化数据中心

管理员可以使用恢复过程以将其数据中心的主数据域替换为新的主数据域，这在主数据域的数据损坏的情况下是必需的。重新初始化数据中心可恢复与数据中心相关联的所有其他资源，包括群集、主机和非争议性存储域。

###### 演示：创建数据中心

安装时会自动创建名为“默认”的数据中心。对于很多网站，可能没有理由在初始数据中心之外再额外创建数据中心。

1. 在 RHEV-M 管理门户中，导航至数据中心选项卡。 - 使用 rhevadmin 用户名和 redhat 密码在域 example.com 中登录 RHEV 管理门户
2. 单击新建按钮，以显示新建数据中心对话框（如下所示），并按照下面的表格填写字段。

添加数据中心

|名称     |数据中心的唯一名称，最多 40 个字符。 例如，dcenter0|
|描述     |该数据中心的较大篇幅描述（可选）。例如，Data Center for Pod 0|
|存储类型   |确定数据中心的数据存储类型：共享（NFS、iSCSI 或 FCP）或本地。与此数据中心连接的所有数据存储都将是其中一种类型。例如，Shared|
|兼容版本   |此数据中心中部署的 RHEV 的版本。保留 3.5 作为默认数据中心版本，除非您从先前版本升级。如果是升级，那么数据中心将是转移到 3.5 的最后一个项目（第一个是主机，然后是群集，最后是数据中心）。例如，3.5|
|定额模式   |定额是红帽企业虚拟化提供的资源限制工具。选择Disabled|

定额模式：

*    禁用：如果您不想限制资源，则选择该选项。
*    审核：如果您要编辑定额设置，则选择该选项。
*    强制：选择该选项实施定额。

3. 出现引导我对话框来引导配置群集、主机和存储时，由于我们将稍后执行这些步骤，因此将选择稍后配置。 您创建的第一个数据中心将不显示引导我对话框，仅后续数据中心显示。
4. 请注意，新数据中心将出现在数据中心列表中，状态为“未初始化”。


### 创建集群

###### 集群

主机（数据中心内的物理节点）组织为集群（集群选项卡）。集群是一组共享相同资源（如逻辑网络和存储域）的主机。集群也是一个迁移域，即虚拟机可在集群内的主机间自由迁移，但不能迁移到集群外的主机。

可为集群分配决定如何在集群中节点之间平衡虚拟机的客户机调度策略。存在三个完善的基本策略：一个空策略（无），一个尽可能均匀分配的策略（均匀分配），以及一个将虚拟机迁移出一个节点（如果它的符合很低，且其他节点上的符合也不是太高)的策略(节能模式）。最后一项策略倾向于在利用率较低时为禁用节点以节省电能。

内存过量使用设置可以调节；可在任何指定节点上将过量使用设置完全关闭或调节为内存的 200%（假设 KSM 和其他技术使得不太可能会需要所有这些内存），同时允许虚拟机即使在大量主机已关闭的情况下仍会继续工作。

###### 优化集群

出于性能考虑，管理员可以使用各种优化功能。此类功能包括内存和 CPU 优化、高可用性和 KSM 调整。

*    内存优化：使管理员可以为集群选择过量使用策略。
*    CPU 线程：利用 CPU 中内置的多线程优势。管理员可以将线程视为 CPU。对于非 CPU 密集型工作负载更有用。
*    内存气球：内存气球是虚拟客户机设备，可用于根据 VM 需求以动态方式重新分发或回收主机内存。管理员可以在集群中为内存气球使用启用优化。
*    KSM 控制：确定主机是否在不同 VM 之间共享相同的内存页。

###### 虚拟机

*    虚拟 CPU：系统管理程序最多支持 160 个物理 CPU，其中最多可对虚拟客户机显示 160 个虚拟化 CPU 。
*    虚拟 RAM：虽然系统管理程序可支持多达 2 TB 的物理 RAM，但 64 位的客户机最多能显示 2 TB 的虚拟 RAM，32 位的客户机最多能显示 4 GB 的虚拟 RAM。
*    虚拟 NIC：系统管理程序可对每个虚拟机显示多个虚拟网络接口卡（多达 8 个）。各虚拟网卡可映射到主机上的不同虚拟网络和物理网卡。
*    PCI 插槽：PCI 插槽（每个虚拟客户机最多 32 个）用于虚拟客户机监视器（每个视频监视器占用一个 PCI 插槽）、NIC（每个网卡占用一个 PCI 插槽、每个“双模式”网卡占用两个插槽）和 IDE 或 VirtIO 硬盘驱动器。还有一些使用 PCI 插槽的系统设备。

###### 在集群中迁移虚拟机

迁移虚拟机是一种网络密集型操作；对于运行两个或更多个虚拟机的主机，迁移所有虚拟机可能是一个漫长且消耗资源的过程。操作的最佳方案包括设置一个最适合设置和要求的策略。例如，如果主机上运行有很多虚拟机，但是仅一个或两个运行关键工作负载，那么管理员应设置选项以仅迁移高可用性虚拟机。

###### 演示：创建新的集群

安装时，自动创建名为“默认”的集群。对于很多网站，可能没有理由在初始集群以外再额外创建新的集群。

1. 导航至集群选项卡。
2. 单击新建按钮，以显示新集群对话框。 常规屏幕可用于设置创建新集群所需的值。

1). 添加集群 - 常规

*    数据中心： 该集群将会在其中注册的数据中心的名称。例如，dcenter0
*    名称： 域的唯一名称，最多 40 个字符。例如，cluster0
*    描述： 该集群的大量描述（可选）。例如，Cluster for Pod 0
*    CPU 类型： 集群之内的所有主机都必须运行相同类型的 CPU（在此识别）。它应该是集群里任何主机中最低的，以在主机之间进行迁移。可在主机选项卡下选中已批准的系统管理程序主机，以在此处确定相应的值。 
*    兼容版本： RHEV 的版本。除非从先前版本升级，否则请选择 3.5。如果是升级，那么集群将是转移到 3.5 的第二个项目（第一个是主机，然后是集群，最后是数据中心）。例如，3.5
*    启用 Virt 服务： 此集群中的主机将用于运行虚拟机（默认设置），并且应选中。例如，checked
*    启用集群服务： 此集群中的主机将用于红帽 Gluster 存储服务器节点，不能用于运行虚拟机。RHEV-H 主机无法添加到此类型的集群。例如，NOT checked
*    启用以设置 VM 维护原因： 将主机切换到维护时启用设置文本原因，从而允许其他管理员可以看到执行此操作的原因。例如，NOT checked
*    必需的随机数字生成器源： 随机数字生成的来源。例如，/dev/random

内存优化策略将用于决定是否在主机上启动虚拟机。既然虚拟机将不会使用它们的全部分配内存，“内存过量使用”策略可能将比它所支持的物理内存更多的虚拟机分配至主机。有三种内存优化：无、服务器负载 (150%) 和 桌面负载 (200%)。为服务器负载和桌面负载定义的内存过量使用的实际百分比可在 RHEV 配置工具中进行调节。

2). 添加集群 - 内存策略

*    无: 不要在该集群的主机上有任何的内存使用过量。例如，None
*    优化虚拟机负载： 允许一定百分比的基于“典型” 虚拟机服务器负载的内存过量使用。默认：150%。
*    优化桌面负载： 允许一定百分比的“典型”虚拟机桌面负载的内存过量。默认：200%。
*    将线程计为内核： 允许虚拟客户机使用主机线程作为虚拟 CPU 内核。对于 CPU 密集程度较弱的工作负载，启用此选项可能很有用。例如，NOT checked
*    启用内存气泡优化: 在此集群中主机上运行的虚拟机内启用内存使用过量。设置此选项时，内存过量使用管理器 (MoM) 将在可能的情况下开始膨胀，但需要满足为每个虚拟机保证内存大小而设置的限制。例如，Checked
*    启用 KSM： 使内核能够检查两个或多个已运行程序并比较它们的内存。如果任何内存区域或页面相同，那么 KSM 会将多个相同内存页降低到单个页。例如，Checked

弹性策略定义在主机脱机的情况下虚拟机将会发生什么情况。有三种弹性策略：迁移、只迁移高度可用的和不迁移。可以按虚拟机将虚拟机设置为“高可用”（将在创建虚拟机时看到此设置）。

3). 添加集群 - 弹性策略

*    迁移虚拟机: 如果主机离线，请迁移所有虚拟机。例如，Migrate Virtual Machines
*    只迁移高度可用的虚拟机： 如果主机离线，请有选择性地迁移虚拟机（只迁移高度可用的）。
*    不迁移虚拟机： 如果主机离线，请不要迁移虚拟机。虚拟机变得不可用。

集群策略定义在创建虚拟机之后如何布置虚拟机。对于每个策略，可以覆盖默认值。共有三个策略可用。

4). 添加集群 - 集群策略

*    策略 power_saving: 根据最低 CPU 利用率，选择运行新虚拟机的主机。此外，如果主机达到了最高服务级别并且处于此状态超过了设定时间，那么虚拟机将逐个迁移到 CPU 利用率最低的下一个主机。Select Policy: power_saving
*    策略 evenly_distributed: 如果主机达到了最高服务级别并且处于此状态超过了设定时间，那么虚拟机将逐个迁移到 CPU 利用率最低的下一个主机。
*    策略 vm_evenly_distributed: 根据虚拟机数量，在主机之间平均分布虚拟机。
*    调度程序优化: 允许优化集群利用率（通过对使用率进行权重分配并选取最适合的主机）或优化速度（用于按主机检查暂挂请求的数量）。Optimize for speed
*    启用信任服务: 允许与 OpenAttestation 服务器集成。启用此选项之前，需要使用 engine-config 工具输入 OpenAttestation 服务器的详细信息。NOT checked
*    启用 HA 保留: 启用 RHEV 以监控高可用性虚拟机的容量。引擎确保在其现有主机意外故障的情况下，集群存在相应的容量来迁移指定为高度可用的虚拟机。NOT checked
*    提供自定义序列号策略: 允许为虚拟机指定序列号。NOT checked

控制台选项卡使管理员能够定义集群的 SPICE 代理。

5). 添加集群 - 集群控制台

围栏策略使管理员能够设置集群的围栏。围栏是指在主机显示为故障时隔离计算机集群中某个节点的过程。

6). 添加集群 - 集群围栏

启用围栏: 为此集群启用围栏。需要围栏设备才能运行。NOT checked
如果主机在存储上具有活动租用则跳过围栏: 启用此选项后，将对在存储域上具有活动租用的主机跳过围栏。
发生集群连接问题时跳过围栏: 启用此选项后，在以下情况下将跳过围栏：具有连接问题的集群主机所占比例大于或等于定义的阈值。

3. 在显示引导我对话框以进一步配置和选择主机时，请选择稍后配置，因为您将单独执行那些步骤。
4. 请注意，新的集群是在集群列表中。
5. 导航至主机选项卡。
6. 如果该主机未经过授权，请选择授权，然后修改数据中心和集群，以反映应该在何处注册主机。

如果该主机已在其他数据中心/集群中获批，请右键单击主机，然后选择维护，以将主机置于“维护模式”。右键单击主机，选择编辑，然后修改数据中心和集群，以反映该在何处注册主机。最后，右键单击主机并选择激活，使主机上线。

### 实验：创建 RHEV 数据中心和集群

在本实验中，您将创建数据中心 testdcX，使用集群 testcluX 以及集群中的主机 servera 来填充此数据中心。 成果.  您应该能够建立一个可用数据中心，其中包含一个由一个主机组成的集群。 

*    创建数据中心 testdcX，该数据中心将共享存储用于 RHEV 3.5 环境。
*    在数据中心内创建名为 testcluX 的集群。
*    将主机 servera.podX.example.com 从数据中心 newdcX 移动到新创建的数据中心。 

1. 使用 rhevadmin 用户名和 redhat 密码在域 example.com 中登录 RHEV 管理门户。

在 workstation 上，打开 Web 浏览器并导航至 https://rhevm.podX.example.com。按照前面所列，填写这些字段。 

2. 创建新数据中心

    1). 导航到数据中心, 单击数据中心选项卡。
    2). 使用以下值创建新的数据中心：
    
        名称：testdcX（其中 X 为您的 pod 号）。
        描述：Test Datacenter
        存储类型：Shared
        兼容版本：3.5
        定额模式：禁用

    单击新建按钮。“新数据中心”对话框显示。使用以上值填写信息, 单击确定。此时将打开“引导我”对话框，其中显示配置任务的列表。单击稍后配置关闭该对话框。 
    
3. 创建新群集

    1). 导航到集群, 单击群集选项卡。
    2). 使用以下值创建新集群：

        数据中心：testdcX（其中 X 为您的 pod 号）。
        名称：testcluX（其中 X 为您的 pod 号）。
        描述：测试群集
        CPU 名称：取决于硬件
        兼容版本：3.5
        对于存储而言启用 Virt 服务
        内存优化：无
        弹性策略：迁移虚拟机 

    单击新建按钮。“新群集”对话框显示。使用以上值填写信息。单击确定。“引导我”对话框打开，其中显示配置任务列表。单击稍后配置关闭该对话框。 
    
4. 将 RHEV-H 主机 (servera) 移动到新集群 (testcluX)

    1). 从左侧窗格中，导航到系统。单击主机选项卡。
    2). 将主机 servera.podX.example.com 置于维护模式。选择主机 servera.podX.example.com，然后单击维护按钮。在打开的“维护主机”窗口中，单击确定，以确认将主机置于维护模式。主机将进入维护模式，这样便可以编辑其属性并且可以将其从 newcluX 集群移动到新的 testcluX 集群。

    3). 在左侧窗格中，单击系统顶级条目，然后单击主机选项卡。设置以下内容：

        数据中心：testdcX
        主机集群：testcluX

    在主机 servera.podX.example.com 仍然突出显示的情况下，单击编辑按钮。此时将打开“编辑主机”窗口。使用先前设置来修改两个下拉菜单。单击确定来保存设置。单击确定忽略“电源管理配置”警告。

    4). 使用新的设置激活主机 servera.podX.example.com。在主机 servera.podX.example.com 仍然突出显示的情况下，单击激活按钮。 

5. 群集验证和来自群集视图的主机

    1). 单击集群选项卡。
    2). 选择集群 testcluX。
    3). 单击下方的主机标签，并确认 servera.podX.example.com 出现在列表中，且状态为启动。 























