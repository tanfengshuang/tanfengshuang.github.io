---
layout: post
title:  "Managing VM Snapshots and Images(318-8)"
categories: Linux
tags: RHCA 318
---

### 创建和使用映像快照

###### 映像管理：快照

快照是虚拟机任何或所有可用磁盘上操作系统以及应用程序的特定时间点视图。管理员可以先对虚拟机拍摄快照，然后再对虚拟机进行可能产生意外结果的更改。管理员可以使用快照将虚拟机返回到先前状态。RHEV 在数据域中管理快照，因此两个虚拟客户机无法同时访问同一映像。

###### 创建快照

快照能够在指定时间指定点获取虚拟机磁盘的状态。能够对机器状态拍摄很多快照，但一次只能使用一张快照。推出的红帽企业虚拟化版本 3.1 支持运行中虚拟机的“实时”快照。虚拟客户机具有代理程序,支持静止的虚拟机能够在快照间确保文件系统一致性。红帽网络注册的红帽企业 Linux 虚拟客户机能够安装 qemu-guest-agent 软件包，然后启用 qemu-ga 服务以在快照之前启用静止。请注意，尝试使用导出的快照时，将其数据置于磁盘上并处于“非稳定状态”的应用程序会发现其自身受到损坏。

RHEV 管理员能够暂时在虚拟机启动状态预览任何快照，确保这正是他们想要使用的快照。管理员能够将磁盘映像永久性地更换为该快照；因而后来所有快照就被永久地删除了。

###### 克隆

另外，从版本 3.1 开始，红帽企业虚拟化提供了从快照创建新虚拟机的功能，称为“克隆。”然而，克隆会具有残余的硬件特定信息，模板就旨在解决该问题。

红帽企业虚拟化 3.5 引入该功能后，我们现在可以直接对虚拟机执行克隆，而无需模板或快照。

从虚拟机选项卡中，选择要克隆的虚拟机，然后单击克隆 VM 按钮，以打开克隆虚拟机窗口。输入新虚拟机的名称，然后单击确定。 

### 共享和编辑映像 

###### 在数据中心间移动映像

RHEV Manager 可以使用行业标准开放虚拟机格式 (OVF) 导入和导出虚拟机及模板。OVF 文件格式是一种合法的 XML 文件，代表一个虚拟机或一个详细的模板，使得可以从一个物理主机导出虚拟机并将虚拟机导入到另一个物理主机。这种导入/导出功能可用于：

*    分配虚拟设备。
*    将虚拟资源移动到同一 RHEV 安装中的不同数据中心。
*    将虚拟资源移动到其他 RHEV 安装。
*    储存虚拟机的完整系统备份以用于灾难恢复。

要从 RHEV 中导出虚拟机，管理员首先需要一个导出域，该域可通过存储选项卡中的新建域选项来访问。域类型需要设置为导出/NFS。创建该域后，管理员可以指定要将域连接到的集群。

> 一个导出域一次只能连接到一个数据中心。同样，一个数据中心同时只能拥有一个连接的导出域。 


在数据中心间移动虚拟机的过程分为五步：

1. 导出域需要连接到源数据中心：
2. 虚拟机现在可以导出到连接的域：
3. 导出完成后，导出域现在可以从数据中心断开：
4. 导出域可以连接到目标数据中心：
5. 连接导出域后，便可以导入虚拟机：
    
###### 导出虚拟机

要导出域，管理员需要执行以下步骤：

1. 需要从 RHEV-M 管理控制台的虚拟机选项卡中选择虚拟机。
2. 选择后，需要关闭虚拟机。
3. 右键单击虚拟机将显示上下文菜单。单击导出将显示导出虚拟机对话框。
4. 通过选择强制覆盖，管理员可以覆盖导出域中可能已存在的现有虚拟机映像。选择折叠快照将为各磁盘创建单个导出文件。如果管理员想要保留虚拟机的源版本和目标版本，可以选择后一个选项。
5. 单击确定将启动导出。

验证后，虚拟机的导出将开始，并且此过程可能需要一些时间，具体取决于底层架构。在导出运行期间，正在导出的虚拟机将处于映像锁定状态。事件选项卡将显示虚拟机已导出。

导出完成后，管理员便可以回到数据中心选项卡，然后选择导出域连接到的数据中心。从下方窗格中的存储选项卡中选择导出域后，管理员可以单击维护按钮以将导出域置于维护模式。当导出域的状态变为不活动状态时，便可以单击分离按钮。导出域现在可以连接到其他数据中心。

###### 导入虚拟机

要将虚拟机导入数据中心，首先需要将其附加到目标数据中心。遵循以下步骤将虚拟机导入目标数据中心：

1. 在 RHEV-M Web 界面中，导航到数据中心选项卡并选择数据中心。
2. 在下方窗格中，导航到存储选项卡，然后单击附加导出按钮。
3. 从列表中选择导出域并单击确定。
4. 等待存储域变为不活动状态，然后将其选中并单击激活按钮。
5. 在存储选项卡上，选择导出数据域。输出数据域的详细信息窗格将显示。
6. 在详细信息窗格中，选择 虚拟机导入选项卡。
7. 选择要导入的虚拟机。
8. 单击导入按钮。此时将显示导入虚拟机对话框。
9. 选择虚拟机的名称，然后选择目标数据中心的目标群集和目标存储。如果尚未在源数据中心中删除原始虚拟机，请选择折叠快照。
10. 单击确定。
    
虚拟机即会导入目标数据中心；根据底层基础架构，此过程可能需要一些时间。 

###### 使用 guestfish 编辑虚拟机映像

Red Hat Enterprise Linux 7 交付时带有基于 libguestfs 库 guestfish 软件包。借助 guestfish 命令，管理员可以在不启动虚拟机的情况下加载并使用虚拟机磁盘映像。这有助于救援机器，还能在导入虚拟机前修改配置。

请考虑以下 guestfish 会话：

```
[root@rhevm ~]# guestfish -i --selinux -w -a /exports/exp/EXPORT-UUID/images/VM-UUID/DISK-UUID
Welcome to guestfish, the libguestfs file system interactive shell for
editing virtual machine file systems.

Type: 'help' for help on commands
      'man' to read the manual
      'quit' to quite the shell
      
Operating system: Red Hat Enterprise Linux Server release 6.2 (Santiago)
/dev/vda2 mounted on /
/dev/vda1 mounted on /boot

><fs> vi /etc/issue
><fs> quit
```

以上用到的选项包括：

*    -i：自动加载虚拟机内找到的所有文件系统
*    --selinux：启用 SELinux 支持
*    -w: 装载映像读写（-r 表示只读）
*    -a image-file：就爱那个 image-file 磁盘添加至虚拟机，能够多次使用

###### 共享和编辑映像

1. 导出 rhel0 虚拟机并在导出期间折叠所有快照。

    浏览虚拟机选项卡。右键单击 rhel0 虚拟机并选择 “导出”。选择折叠快照复选框并按确定。等待导出完成。

2. 分离并删除 exp0 导出域。

    导航至数据中心选项卡。选择 dcenter0 数据中心。在底部窗格中，右键单击 exp0 导出域并选择 “维护”。导出域处于维护模式后，右键单击新的导出域并选择 “分离”。单击确定以确认。

    导航至存储选项卡。右键单击 exp0 存储域并选择 “删除”。单击确定按钮。强调不要选中格式化域框。

3. 成功导出虚拟机之后，继续删除虚拟机。

    在虚拟机选项卡中，右键单击 rhel0 虚拟主机并选择 “删除”。单击确定以确认。

4. 在 rhevm.podX.example.com 机器上，以 root 身份登录。安装 libguestfs-tools 包。 - yum -y install libguestfs-tools

5. 安装虚拟机导出图像，以便可对其进行更新。

```
[root@rhevm ~]# guestfish -i -w -a /exports/exp/EXPORT-UUID/images/VM-UUID/DISK-UUID
Welcome to guestfish, the libguestfs filesystem interactive shell for
editing virtual machine filesystems.

Type: 'help' for help on commands
      'man' to read the manual
      'quit' to quit the shell

Operating system: Red Hat Enterprise Linux Server release 7.1 (Maipo)
/dev/sda2 mounted on /

><fs> 
```

6. 编辑 /etc/issue 文件并从磁盘图像断开。

```
><fs> vi /etc/issue
><fs> exit
```

7. 导入导出域。

浏览 RHEV-M web 界面，并选择存储选项卡。单击导入域按钮。确认已将域功能/存储类型设为导出/NFS。对于导出路径，输入 rhevm.podX.example.com:/exports/exp 并单击确定按钮。 

8. 激活导出域。

导航至数据中心选项卡并突出显示 dcenter0 数据中心。在底部窗格中，右键单击 exp0 导出域并选择 “激活”。

9. 导入虚拟机。

返回存储选项卡，突出显示 exp0 导出域。在底部窗格中，导航至 VM 导入选项卡。右键单击 rhel0 虚拟机并选择 “导入”。将设置保留为默认值并按确定以确认。 

    

