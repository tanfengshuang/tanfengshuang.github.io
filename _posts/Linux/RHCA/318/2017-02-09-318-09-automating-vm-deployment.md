---
layout: post
title:  "Automating VM Deployment(318-9)"
categories: Linux
tags: RHCA 318
---


### 模板创建过程

###### 使用模板快速部署

模板是预配置虚拟机的副本，用于简化类似虚拟机的后续重复创建。模板会捕获原始虚拟机的已安装软件、软件配置和硬件配置。当管理员需要部署多个（几乎）相同的机器时，与进行多次安装相比，使用模板可能非常有益。模板可以看作是对原始磁盘映像的逐位复制，并且与使用 Clonezilla 或 Ghost 等工具创建机器映像非常相似。正如 kickstart 等自动化安装一样，这将有助于在多个机器间保持一致，从而简化管理和故障排除工作。

使用虚拟机时，以模板为基础构建机器还有助于减少内存使用，因为内核同页合并 (KSM) 更有可能在相同的机器上找到重复内存页面。

使用模板还可以帮助减少所需磁盘空间量。不需要克隆模板（但因为性能原因可以克隆模板）。相反，将一个小重叠放在基础映像上可存储一个具体实例的更改。进行桌面部署和部署磁盘变动不大的服务器（例如，托管农场中的 Web 服务器）时，使用这种精简资源调配方法尤其有用。

当管理员想要使用池时，也需要使用模板，具体将在下一章节中讨论。当他们在使用后返回池时，池中的虚拟机将恢复到基准模板。

> 与使用模板相关的一个挑战是确保不遗留任何识别信息，例如有关 MAC 地址或 SSL 证书的信息，因为在相同模板上部署多台机器时，这些识别信息可能会产生问题。此进程叫做密封映像。


请考虑以下列表，其描述了在 RHEV 中创建模板所需的一般步骤：

1. 安装要作为模板基准的最新虚拟机。它将基于空白模板。
2. 从新虚拟机上删除所有主机特定信息（密封机器）。这包括虚拟硬件信息，例如 MAC 地址和唯一系统配置（例如主机名称和静态 IP 地址）。
3. 正常关闭封装完成的虚拟机。
4. 从虚拟机中创建模板。
5. 通过基于新模板创建另一个虚拟机来测试模板。 

下表描述了新建模板窗口的设置：

*    名称: 模板的名称。这是通过 REST API 访问模板时和管理门户中模板选项卡上列出模板时使用的名称。此文本字段限制为 40 个字符，并且必须是唯一名称，具体可为大写字母、小写字母、数字、连字符和下划线的任意组合。
*    描述: 模板的描述。建议使用此字段，但并非必需。
*    评论: 用于添加模板相关纯文本可读注释评论的字段。
*    群集: 与模板关联的群集。默认情况下，这与原始虚拟机相同。可以选择数据中心内的任何群集。
*    创建为子模板版本: 指定模板是否创建为现有模板的新版本。管理员可以选中此复选框，以访问用于配置此选项的设置。

    根模板：在其下添加子模板的模板。
    子版本名称：模板的名称。这是在基于模板创建新虚拟机时访问模板所使用的名称。

*    磁盘分配: 

    别名：模板所用虚拟机磁盘的别名。默认情况下，别名的值与源虚拟机的别名相同。
    虚拟大小：模板所用虚拟磁盘的当前实际大小。此值无法编辑，仅供参考。
    目标：模板所用虚拟磁盘所在的存储域。默认情况下，存储域的值与源虚拟机的存储域相同。可以选择群集中的任何存储域。 

*    允许所有用户访问此模板: 指定模板是公共还是私有。公共模板可以由所有用户访问，而私有模板只能由 TemplateAdmin 或 SuperUser 角色的用户访问。
*    复制 VM 权限: 将已在源虚拟机上设置的显式权限复制到模板。

要创建模板，管理员需要选择虚拟机选项卡，右键单击要用于模板的虚拟机，然后从菜单中选择 “制作模板” 。

### 使用模板映像创建 RHEL VM

###### 封装 Red Hat Enterprise Linux 6 用于部署

通常情况下，将会从单个模板创建出多个虚拟机，因此所有机器特定信息都应该从将用作模板的系统中删除。理想情况下，虚拟机启动时将自动检测或重新生成机器特定信息，而无需任何操作员干预。该信息包括但不限于以下部分（下表还显示了如何从系统中删除该信息）。 

识别信息 	如何删除

*    静态 IP 配置: 确保 BOOTPROTO=dhcp 已在所有 /etc/sysconfig/network-scripts/ifcfg-* 文件中（除 ifcfg-lo 之外）设置，或者确保系统在第一次启动时重新配置网络。
*    参考 MAC 地址和其他硬件特定信息: 删除所有 /etc/udev/rules.d/*-persistent-*.rules 文件，并从 /etc/sysconfig/network-scripts/ifcfg-* 中删除所有 HWADDR= 行。
*    主机名:	从 /etc/sysconfig/network 中删除 HOSTNAME= 行，或者设置 HOSTNAME=localhost.localdomain。这会导致网络脚本为动态 IP 地址进行反向 DNS 查询，以设置主机名。
*    SSH 主机密匙: 删除文件 /etc/ssh/ssh_host* 和 /etc/ssh/moduli。
*    SSL 证书: 确保在 /etc/pki/tls/certs/、/etc/pki/tls/private/ 中或应用程序可能储存密匙的其他位置没有留下具体机器证书或密匙。
*    Kerberos keytabs: 删除 /etc/krb5.keytab 和其他应用程序特定 Kerberos keytabs。
*    RHN 系统 ID: 删除文件 /etc/sysconfig/rhn/systemid。 

###### 封装 Red Hat Enterprise Linux 7 用于部署

Red Hat Enterprise Linux 7 已将部分识别信息转移到新位置。下表开始列出其中一些更改（仍应将上表视为起点）。

识别信息 	如何删除

*    主机名 	大多数 Red Hat Enterprise Linux 7 文档建议删除 /etc/hostname。相反，将主机名设置为 localhost ，以在系统初始化时触发反向 DNS 查询（man page 中建议的空白主机名不会在 RHEL 7.1 中触发查询）。

    # hostnamectl set-hostname "localhost"

*    订阅: 使用 subscription-manager unregister 以删除所有 RHSM 配置。
*    机器 ID: 考虑 /etc/machine-id 是否需要在环境中保持唯一。查看 man page 中的 machine-id(5)、systemd-firstboot(1) 和 systemd-machine-id-setup(1) 信息，以了解可能的方法。

###### 使用 virt-sysprep 进行封装

通过直接访问已关闭 Red Hat Enterprise Linux 虚拟机的磁盘映像，管理员可以使用 virt-sysprep 命令删除机器特定信息。此工具是封装映像的建议工具。 

```
[student@workstation ~]$ virt-sysprep --list-operations
abrt-data * Remove the crash data generated by ABRT
bash-history * Remove the bash history in the guest
blkid-tab * Remove blkid tab in the guest
ca-certificates   Remove CA certificates in the guest
crash-data * Remove the crash data generated by kexec-tools
cron-spool * Remove user at-jobs and cron-jobs
customize * Customize the guest
dhcp-client-state * Remove DHCP client leases
dhcp-server-state * Remove DHCP server leases
dovecot-data * Remove Dovecot (mail server) data
firewall-rules   Remove the firewall rules
flag-reconfiguration   Flag the system for reconfiguration
fs-uuids   Change filesystem UUIDs
kerberos-data   Remove Kerberos data in the guest
logfiles * Remove many log files from the guest
lvm-uuids * Change LVM2 PV and VG UUIDs
machine-id * Remove the local machine ID
mail-spool * Remove email from the local mail spool directory
net-hostname * Remove HOSTNAME in network interface configuration
net-hwaddr * Remove HWADDR (hard-coded MAC address) configuration
pacct-log * Remove the process accounting log files
package-manager-cache * Remove package manager cache
pam-data * Remove the PAM data in the guest
puppet-data-log * Remove the data and log files of puppet
rh-subscription-manager * Remove the RH subscription manager files
rhn-systemid * Remove the RHN system ID
rpm-db * Remove host-specific RPM database files
samba-db-log * Remove the database and log files of Samba
script * Run arbitrary scripts against the guest
smolt-uuid * Remove the Smolt hardware UUID
ssh-hostkeys * Remove the SSH host keys in the guest
ssh-userdir * Remove ".ssh" directories in the guest
sssd-db-log * Remove the database and log files of sssd
tmp-files * Remove temporary files
udev-persistent-net * Remove udev persistent net rules
user-account   Remove the user accounts in the guest
utmp * Remove the utmp file
yum-uuid * Remove the yum UUID
```

要删除默认信息，管理员可以使用 virt-sysprep -a disk.img。man page 包含此实用程序作者提供的建议。然后，可在首次启动时使用 libguestfs-tools 进行一些自动化操作，以避免操作员交互。


###### 封装红帽企业 Linux 7 用于部署

1. 确保 rhel0 正在运行，打开其控制台，然后以 root 身份登录虚拟机。
2. 通过运行以下命令，删除所有 SSH 主机密钥：

    # rm -f /etc/ssh/ssh_host_*

3. 删除 /etc/hostname。

    # hostnamectl set-hostname "localhost"
    
4. 确保在 /etc/pki/tls/certs/、/etc/pki/tls/private/ 中或应用程序可能储存密钥的其他位置处都没有留下机器特定证书或密钥。
5. 从 /etc/sysconfig/network-scripts/ifcfg-eth* 中的 UUID 和 HWADDR 行中删除值。

    # vi /etc/sysconfig/network-scripts/ifcfg-eth0

6. 从 /var/log/ 中删除所有日志，并从 /root 中删除构建日志。

    # rm -rf /var/log/*

7. 最后，运行 sys-unconfig 以完成该过程并关闭虚拟机。 
          
###### 为手动部署进行封装

手动部署的含义是，系统会向启动结果虚拟机的用户显示提示，供其输入基本配置信息（如网络设置），以使虚拟机可以运行。

虽然存在一种名为 sys-unconfig 的工具，该工具可在运行中的虚拟机上运行，但该实用程序无法完成以上所有操作。如所列参考中所述，sys-unconfig 仅删除持久的 udev 规则并通过创建文件 /.unconfigured，将系统置于手动重新配置模式。

还有另一种替代方法，可用于手动将系统置于重新配置模式。要使用此方法，管理员可以执行以下步骤：

```
[root@vmY ~]# yum -y install firstboot
[root@vmY ~]# chkconfig firstboot on
[root@vmY ~]# sed -i 's/^RUN_FIRSTBOOT=.*/RUN_FIRSTBOOT=YES/' /etc/sysconfig/firstboot
[root@vmY ~]# touch /etc/reconfigSys
```

要创建诸如 Kerberos 密钥表之类的机器特定信息，管理员可以使用红帽卫星网络等配置管理系统，或者编写自定义首次启动模块。

准备好创建模板后，关闭虚拟机。 

###### 演示：创建 Red Hat Enterprise Linux 7 模板

此处遵循基于 Red Hat Enterprise Linux 7 虚拟机创建模板的步骤并假定虚拟机已“封装”： 

1. 确保虚拟机已关闭且在 RHEV-M 中报告的状态为关闭。
2. 在 RHEV-M Web 界面的虚拟机选项卡中，选择虚拟机，并单击制作模板。
3. 在出现的新建模板对话框中，输入所需的名称 (rhel0-template) 和描述 (My template)。单击确定以创建模板。
4. 在 RHEV-M Web 界面中，导航到模板选项卡，并确认新模板显示在那里。在继续前，请等待状态从已锁定变为正常。 

###### 基于模板创建新的 Red Hat Enterprise Linux 7 虚拟服务器

创建虚拟机的模板后，管理员可以使用该模板来创建新服务器。 

1. 要基于模板创建新的 Red Hat Enterprise Linux 虚拟服务器，请登录 RHEV 管理门户并导航到虚拟机选项卡。单击新建 VM 按钮，以显示新建虚拟机对话框。
2. 在此对话框中，输入名称 (rhel0-base) 和描述 (Template Child)。在基于模板下拉菜单中，选择之前的模板 (rhel0-template)。
3. 在新建虚拟机对话框仍然打开的情况下，导航到资源分配选项卡。在此，选择如何为新服务器配置虚拟磁盘。如果资源调配设置为精简，将会在原始模板顶部使用重叠。如果资源调配设置为克隆，那么将克隆原始模板，并且用于选择（按磁盘）预分配映像或精简资源调配磁盘的选项变为可用。
4. 单击确定以创建虚拟机。在继续前，请等待状态从已锁定转为正常。
5. 在虚拟机选项卡中，右键单击新虚拟机并从上下文菜单中选择运行来启动新虚拟机。
6. 通过右键单击虚拟机并从上下文菜单中选择控制台，打开新虚拟机的控制台。

###### 练习：使用模板映像创建 RHEL VM

在本实验中，您将从 Red Hat Enterprise Linux 7 虚拟机创建模板，并使用该模板来配置新服务器。

成果. 您应该能够基于新创建的 Red Hat Enterprise Linux 7 模板配置新的虚拟服务器。 

1. 以 rhevadmin 身份登录 RHEV 管理门户并选择虚拟机选项卡。
2. 确保 rhelX 虚拟机正在运行。系统启动完成后，打开控制台并以用户名 root 和密码 redhat 登录。
3. 要使系统准备就绪能够成像，需手动删除所有主机特定的信息。确保至少删除以下内容：

*    MAC 地址的所有引用。
*    所有 SSH 密钥。
*    嵌入式主机名。
*    与此系统关联的 RHN systemid 文件。

要删除对 MAC 地址的所有引用，必须执行两项操作：删除 /etc/udev/rules.d/*-persistent-*.rules 并从 /etc/sysconfig/network-scripts/ifcfg-* 中删除所有 HWADDR 和 UUID 行。为此，请执行下列命令：

```
[root@vmY ~]# rm -f /etc/udev/rules.d/*-persistent-*.rules
[root@vmY ~]# sed -i '/^HWADDR=/d' /etc/sysconfig/network-scripts/ifcfg-*
[root@vmY ~]# sed -i '/^UUID=/d' /etc/sysconfig/network-scripts/ifcfg-*
```

要删除所有 SSH 密钥，请从 /etc/ssh/ 中删除 moduli 和 ssh_host* 文件：

    [root@vmY ~]# rm -f /etc/ssh/moduli /etc/ssh/ssh_host*

删除嵌入式主机名：

    [root@vmY ~]# hostnamectl set-hostname "localhost"

要删除与此系统关联的 RHN systemid，请执行下列命令：

    [root@vmY ~]# rm -f /etc/sysconfig/rhn/systemid

4. 通过运行 poweroff 命令，关闭 rhelX 机器。
5. 在虚拟机选项卡中，选择 rhelX 机器并单击制作模板。将 rhel71-server 用作名称并将 Basic RHEL7.1 Server 用作描述。
6. 等待模板的创建。这将仅花费两三分钟的时间。
7. 仍在虚拟机选项卡中，单击新建 VM 按钮。选择在先前步骤中创建的 rhel71-server 模板。使用 One-More-Server 作为名称，并使用 Testing The Template 作为描述。单击确定以完成机器创建。
8. 启动新 One-More-Server 机器并连接到控制台。通过以 root 身份和密码 redhat 登录并执行以下命令，验证是否成功建立网络连接：

    [root@vmY ~]# ping -c3 172.25.254.254

9. 由于磁盘空间有限，因此请删除新的 VM。在虚拟机选项卡上，突出显示 One-More-Server 机器。按删除按钮。确认删除。 


### 使用模板映像创建 Windows VM

###### 封装 Windows 用于部署

封装 Windows 机器的方式略微不同于封装 Red Hat Enterprise Linux 机器。开始从 Windows Server 2008 或 Windows 7 主机删除机器特定信息之前，管理员必须确保 Windows 机器首次启动时将会在名为 sysprep.inf 的文件中查找配置信息。RHEV 将会在虚拟软盘上提供 sysprep.inf 文件。Windows 的这些版本不再自动搜索软盘驱动器，因此必须将它们配置为搜索此虚拟软盘驱动器。要封装 Windows 机器，请考虑以下步骤：

1. 为要创建模板的 Windows 机器打开控制台，并登录。
2. 按 Windows+R 以启动运行对话框。输入 regedit 并按 Enter。单击确定，以为正在运行的 regedit 授予系统权限。
3. 在注册表编辑器窗口中，使用左树导航到 HKEY_LOCAL_MACHINE → SYSTEM → 设置。在右窗格中，右键单击并选择新建 → 字符串值。输入 UnattendFile 作为项名。双击新项并将值设置为 a:\sysprep.inf。这将允许 Windows 找到 sysprep.inf 文件，因此 RHEV 将使用新的机器。关闭注册表编辑器窗口。以下截图显示了 regedit，其中项 UnattendFile 突出显示。

就像 Red Hat Enterprise Linux 系统一样，Windows 系统会存储机器特定信息，例如 MAC 地址和安全证书。要删除所有这些识别信息并强制让 Windows 在下次重新启动时进入最小化安装，管理员可以使用 Windows 附带的 sysprep.exe 工具。sysprep.exe 通常可以在 Windows Server 2008 和 Windows 7 机器的 C:\Windows\System32\sysprep\ 中找到。当 sysprep.exe 启动时，将显示一个窗口， 在系统清理操作下拉列表中，选择进入系统全新体验 (OOBE)，然后选中通用，以表明应该删除硬件特定信息。在关机选项中，选择关机，以指示 sysprep.exe 应在完成时发起关机。

###### 创建 Windows 模板

现在已封装虚拟机映像且虚拟机已关闭，管理员可以基于该虚拟机创建模板。请考虑以下步骤来在 RHEV 中创建 Windows 模板。

1. 登录 RHEV-M Web 界面并导航到虚拟机选项卡。
2. 选择要用作模板基础的虚拟机。右键单击虚拟机，然后从上下文菜单中选择制作模板。
3. 在显示的新建模板对话框中，输入要用于新模板的名称和描述并单击确定按钮以开始模板创建。
4. 创建模板期间，该虚拟机将会过渡到映像锁定状态。这可能需要一两分钟，因为将要复制整个映像。

###### 基于模板创建新的 Windows 虚拟桌面

密封 Windows 机器并创建模板后，管理员便可以使用该模板来创建新的虚拟服务器。请考虑以下步骤来创建新虚拟机：

1. 要基于模板创建新的虚拟桌面，管理员可以登录 RHEV-M web 界面并导航到虚拟机选项卡。单击新建 VM 按钮以打开新建虚拟机对话框。
2. 在该对话框中，输入要用于新虚拟桌面的名称和描述。在基于模板下拉菜单中，选择要用作虚拟机基础的模板。
3. 如果所选模板的操作系统设为 Windows，新建虚拟机对话框中将会出现一个新的选项卡：Windows Sysprep。导航到此选项卡，然后从域下拉菜单中选择 Windows Active Directory 域。可以在此处设置新虚拟桌面的所需时区。 

> 慎重地为基于 Windows 的系统选择兼容 Active Directory 的域，以便可以向其正确注册。只有使用 rhevm-manage-domains 实用程序添加的域才会显示在此列表中。如果未列出所需的域，那么必须首先使用此实用程序将该域添加到 RHEV-M。 

4. 在新建虚拟机对话框仍然打开的情况下，导航到资源分配选项卡。此处可以选择新的虚拟机是否应该运行模板的克隆复本（性能更好，但需要更多磁盘空间），或者新的虚拟桌面是否应该从原始模板上的重叠运行（性能略差，但更有效地使用可用存储空间）。新虚拟桌面的默认值是资源调配设为精简（重叠）。
5. 根据需要修改所有设置后，单击确定以创建新虚拟机。新虚拟机将会出现，状态为映像锁定。继续之前，等待机器报告关闭。
6. 第一次启动新虚拟机时，需要对其进行配置。若要进行此操作，请在 RHEV-M 界面的虚拟机选项卡中选择虚拟机，右键单击虚拟机，然后从菜单中选择运行一次。在出现的运行虚拟机对话框中，确保已连接 [sysprep] 软盘，且域已设为您之前配置的域。单击确定以启动虚拟机。
7. 虚拟机启动后，打开控制台并等待 Windows 完成配置系统。虚拟机重启后，会出现一个 Windows 登录屏幕。 

### 创建和管理池

###### 池

虚拟机池由一组虚拟机组成，这些虚拟机全部都是同一个模板的克隆，可由给定组中的任何用户按需使用。借助虚拟机池，管理员可以为用户快速配置一组通用虚拟机。

用户可以通过访问虚拟机池来从池中获取虚拟机。当用户从池中获取虚拟机时，系统将为用户提供池中的任何一个虚拟机（如果有虚拟机可用的话）。该虚拟机的操作系统和配置与池所基于的模板相同，但用户每次获取虚拟机时，可能收到该池中的不同成员。用户还可以从同一个虚拟机池中获取多个虚拟机，具体取决于该池的配置。

虚拟机池中的虚拟机无状态，这意味数据会在重新启动后消失。不过，如果用户为从虚拟机池中获取的虚拟机配置了控制台选项，那么这些选项将设为该虚拟机池中针对该用户的默认设置。

在原则上，池中的虚拟机会在用户获取时启动，并且在用户结束使用时关闭。但是，虚拟机池也可以包含预先启动的虚拟机。预先启动的虚拟机会一直保持启动状态，并在用户获取前处于空闲状态。这样，用户便可以立即开始使用此类虚拟机，但由于这些虚拟机一直处于空闲状态，因此即使未在使用也会消耗系统资源。

> 从管理门户中访问从池中获取的虚拟机时，这些虚拟机并非处于无状态。这是因为管理员需要能够在必要时将更改写入到磁盘。

可以有多个池，每个池具有自己的映像。例如，您可以为市场营销部门建立单独的池，再为财务部门建立另一个池。用户不会总是获得同一虚拟机，但用户将从相应的池中获取所需类型的可用虚拟机。

###### 创建池

创建池之前，必须指定用作池基础的模板。构建模板后，管理员可以登录 RHEV-M Web 界面和导航到池选项卡。单击新建将显示用于定义新池的对话框。 在此对话框中，管理员可以设置各种选项。下表详述了新建池窗口的常规选项卡上特定于虚拟机池的必需信息。所有其他设置都与新建虚拟机窗口中的对应设置完全相同。

常规设置

*    虚拟机的数量： 让管理员可以指定虚拟池中将创建的虚拟机数量以及在创建虚拟机池之后在虚拟机池中可用的虚拟机数量。默认情况下，可在池中创建的虚拟机最大数量是 1000。可以使用 engine-config 命令的 MaxVmsInPool 键来配置此值。
*    每位用户的最大 VM 数量： 让管理员可以指定单个用户一次可以从虚拟机池中获取的最大虚拟机数量。此字段的值必须介于 1 到 32,767 之间。

池类型：此下拉菜单让管理员可以指定虚拟机池的类型。可用选项如下：

*    自动：在用户使用完从虚拟机池获取的虚拟机之后，该虚拟机会自动返回到虚拟机池。
*    手动：在用户使用完从虚拟机池获取的虚拟机之后，该虚拟机只有在管理员手动返回虚拟机时才会返回到虚拟机池。

控制台设置

*    覆盖 Spice 代理 	选中此复选框可覆盖全局配置中定义的 Spice 代理。当用户（例如，通过用户门户连接的用户）位于系统管理程序所在的网络之外时，此功能很有用。
*    覆盖的 Spice 代理地址 	Spice 客户端连接到虚拟机时使用的代理。此代理将覆盖为红帽企业虚拟化环境定义的全局 Spice 代理，以及为虚拟机池所属群集定义的 Spice 代理（如果有）。地址必须为以下格式：protocol://[host]:[port]。 

当管理员单击确定以创建池时，将同时创建池和池中的虚拟机。虚拟机将拥有 池名称-编号 的名称。例如，如果池名为 marketing-desktops 并且选择要创建三个虚拟机，那么将创建三个虚拟机，名称分别为 marketing-desktops-1、marketing-desktops-2 和 marketing-desktops-3。要查看这些虚拟机，既可以在池选项卡中通过选择池并导航到下方窗格中的虚拟机选项卡来查看，也可以通过导航到顶部窗格中的虚拟机选项卡来查看。属于池的虚拟机将在其名称旁带有一个小的池图标，管理员通常会在此看到桌面或服务器图标。

> 以这种方式创建的池尚不能使用。要使池变得完全能够使用，还需向池分配用户。

### 使用 cloud-init 自动执行 RHEL 部署

###### cloud-init 概述

红帽提供了一个预安装映像以供下载，该映像可在虚拟化基础架构和云部署中使用。尽管可以从 http://access.redhat.com 中与安装程序相同的页面上下载原始 KVM qcow2 磁盘映像，但红帽企业 Linux 7 服务器 - RH Common (RPM) 频道/软件仓库中也提供了 rpm 包。cloud-init 包在该相同频道/软件仓库中提供，并且预安装在该映像中。

cloud-init 工具可用于自动执行虚拟机的初始设置，比如配置主机名、网络接口和授权密钥。在对基于模板部署的虚拟机进行配置时，可以使用此工具，以在网络上避免冲突。要使用此工具，必须先在虚拟机上安装 cloud-init 软件包。安装后，cloud-init 服务将在引导过程中启动，以搜索有关配置对象的指令。管理员随后可以使用运行一次窗口中的选项，以仅提供这些指令一次，或者使用新建虚拟机、编辑虚拟机以及编辑模板窗口中的选项，以在虚拟机每次启动时提供这些指令。

cloud-init 可用于在各种情况下自动执行虚拟机配置。以下是几种常见情况：

*    基于模板创建的虚拟机：管理员可以在运行一次窗口上使用初始运行部分中的 cloud-init 选项，以初始化基于模板创建的虚拟机。这让管理员可以在虚拟机首次启动时自定义虚拟机。
*    虚拟机模板：管理员可以在新建模板和编辑模板窗口上使用初始运行选项卡中的使用 Cloud-Init/Sysprep 选项，以指定用于自定义基于该模板创建的虚拟机的选项。
*    虚拟机池：管理员可以使用在新建池窗口上使用初始运行选项卡中的使用 cloud-init/Sysprep 选项，以指定用于自定义从虚拟机池获取的虚拟机的选项。这让管理员可以指定一组标准设置，每次从该虚拟机池中获取虚拟机时，都将应用这些标准设置。既可以继承或覆盖针对虚拟机所基于的模板指定的选项，也可以指定虚拟机池本身的选项。 

###### 演示：使用 cloud-init 初始化虚拟机

1. 从 workstation 中，以 SSH 方式登录 rhevm.podX.example.com： ssh root@rhevm
2. 安装包含以下映像的 rhel-guest-image RPM 文件：

```
[root@rhevm ~]# yum install http://content.example.com/rhel7.1/x86_64/extras/Packages/rhel-guest-image-7-7.1-20150224.0.el7.noarch.rpm
...
Total size: 346 M
Installed size: 346 M
Is this ok [y/d/N]: Y
```

3. 在 RHEV 中，使用 engine-image-uploader 命令上传该映像：

```
[root@rhevm ~]# cd /usr/share
[root@rhevm ~]# engine-image-uploader -e exp0 --name cloud-init upload rhel-guest-image-7/rhel-guest-image-7.1-20150224.0.x86_64
Please provide the REST API password for the admin@internal oVirt Engine user (CTRL+D to abort): redhat
```

4. 从 workstation 中，登录 RHEV 管理门户。
5. 浏览到系统 → 存储，然后单击 exp0 存储。
6. 从下方的窗格中，单击模板导入选项卡，以列出所有可用的映像。
7. 选择 cloud-init 条目，然后单击导入按钮。
8. 从弹出菜单中，针对默认存储域选择 data0，然后单击确定以启动导入过程。请勿选中克隆框。
9. 浏览到系统 → 数据中心 → dcenter0，然后单击模板。确保虚拟机 cloud-init 的状态设置为正常。如果不是，请等待已锁定状态变为正常状态。
10. 仍在同一数据中心中，单击 VM 条目，然后单击新建 VM 以显示助理。
11. 为基于模板选项选择 cloud-init。
12. 为名称输入 vm-cloudinit-demo。
13. 在 nic1 选项中，单击下拉菜单以显示所有可用的网络接口。单击 rhevm (rhevm)。
14. 单击显示高级选项，然后选择初始运行部分。选中使用 Cloud-Init/Sysprep 复选框。
15. 输入 vm-cloudinit-demo 作为 VM 主机名。
16. 选中配置时区复选框，然后从时区下拉菜单中选择时区。 
17. 展开身份验证可折叠项。输入 student 作为用户名并输入 redhat 作为密码。在第二个字段（即验证密码）中，重新输入密码。

（可选）在 SSH 授权密钥文本区域中，输入要添加到虚拟机中授权主机文件的任何 SSH 密钥。

如果已输入 SSH 密钥，请选中重新生成 SSH 密钥复选框，以重新生成虚拟机的 SSH 密钥；否则，请勿选中此选项。

18. 在网络部分下的 DNS 服务器文本字段中，输入 IP 地址 172.25.254.254，并在 DNS 搜索域文本字段中输入 podX.example.com。

19. 选中网络复选框并使用 + 新增，以向虚拟机添加网络接口。单击编辑该字段以显示 eth0。确保为引导协议设置了 DHCP 并选中引导时启动。

20. 最后，在自定义脚本文本区域中，输入以下行： 

```
runcmd:
  - echo redhat | passwd --stdin root
  - echo "This VM has been provisioned using cloud-init" >> /etc/motd
```

21. 单击确定，以使用 cloud-init 作为资源调配方法开始创建虚拟机。
22. 虚拟机创建完成后，等待其变为关闭状态。单击绿色箭头以将其启动。
23. 虚拟机启动并开始运行后，以 SSH 方式登录并验证屏幕上是否显示以下消息：

    This VM has been provisioned using cloud-init

（可选）启动控制台，以检索虚拟机的状态。 

> 即使 cloud-init 尚未配置系统，它也将显示机器已启动，并在控制台上显示登录提示符。如果正在查看控制台，请等待其将主机名更改为指定的主机名。
