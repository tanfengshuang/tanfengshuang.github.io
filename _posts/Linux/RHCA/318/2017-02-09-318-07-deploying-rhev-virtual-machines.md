---
layout: post
title:  "Deploying RHEV Virtual Machines(318-7)"
categories: Linux
tags: RHCA 318
---

### 安装新的虚拟服务器

要创建新的服务器，请登录到 RHEV-M Web 界面并导航到虚拟机选项卡。在本实验中，有新建 VM 按钮。要为新服务器进行资源调配，请单击新建 VM 按钮。执行此操作将出现一个对话框，可定义虚拟机的基本参数。

为新的虚拟服务器配置所有硬件之后，接着就应该安装操作系统。如果正常启动虚拟机，那么它可能会尝试从（空）硬盘启动，因此请以其它方式启动。为此，请在虚拟机中选择新的虚拟机，然后右键单击并选择运行一次。这将调出运行虚拟机，在其中可以指向操作系统安装程序，可能源自 ISO 库/存储域。

### 管理虚拟机

###### 启动和停止虚拟机

要启动当前处于停止状态的虚拟机，请导航到 RHEV-M Web 界面中的虚拟机选项卡并选择要启动的虚拟机。要使用正常配置启动虚拟机，请单击运行图标（绿色播放按钮），或者右键单击虚拟机，然后从菜单中选择运行。

要使用非默认设置运行虚拟机，请右键单击虚拟机，并选择运行一次。这将弹出先前讨论过的运行虚拟磁盘对话框。

关闭虚拟机的选项有以下三个：

*    在虚拟机自身内将其关闭，例如通过在红帽企业 Linux 操作系统主机中使用 poweroff 命令。
*    右键单击虚拟机并选择关闭。这将向虚拟机发送一个虚拟 ACPI 电源按钮事件。请注意，在某些情况下，虚拟机上运行的操作系统可能会忽略该事件（例如，Windows 7 显示登录屏幕）。
*    在 RHEV-M Web 界面中，右键单击虚拟机并从菜单中选择关闭。这将有效拉动虚拟机的电源线，导致非正常关机。请谨慎使用此方法（仅在万不得已时）。

也可以暂停虚拟机，方法是在 RHEV-M Web 界面中选择该虚拟机并单击红色的暂停按钮。已暂停的虚拟机将有效进入休眠模式。其内存和 CPU 状态将保存到磁盘并暂停虚拟机。要稍后恢复运行暂停的虚拟机，请右键单击该虚拟机并从菜单中选择运行。 

###### 编辑虚拟机

要永久更改虚拟机的设置，请导航到 RHEV-M Web 界面中的虚拟机选项卡，并选择要编辑的虚拟机，然后右键单击该虚拟机并从菜单中选择编辑。此时将弹出编辑服务器虚拟机对话框，如下所示。

编辑服务器虚拟机对话框与先前讨论的新建服务器虚拟机对话框几乎相同，但此处有些选项为灰色。请注意，要更改内存大小或 CPU 配置，必须先关闭虚拟机。

> 某些设置（如更改操作系统）可对虚拟机产生以重大影响。在进行更改之前，请确保拥有最新备份。

要向虚拟机添加额外的网卡或磁盘，请首先关机。使用引导我功能，或使用下面窗格中的网络接口和/或虚拟磁盘选项卡来添加、编辑或删除虚拟网卡和磁盘。

> 删除磁盘或网卡时要小心。删除磁盘时，其内容将永久丢失。删除并重新添加网卡时，该卡的 MAC 地址可能会改变，强制要求更新该机器上的 udev 规则和网络配置文件。

###### 删除虚拟机

要删除虚拟机，请先正常关机，然后在 RHEV-M Web 界面中的虚拟机选项卡中将其选中，然后右键单击该虚拟机并从菜单中选择删除。在确认对话框中，单击确定以确认删除此虚拟机。

> 删除虚拟机时，所有与该虚拟机关联的资源也将被删除。其中包括该虚拟机已配置的所有虚拟磁盘和虚拟网卡。删除虚拟磁盘后，该磁盘及其内容将全部丢失。 

### 安装半虚拟化驱动程序和虚拟客户机代理

###### 半虚拟化驱动程序

提高 Microsoft Windows 客户机性能的最佳方式之一是将半虚拟化设备和驱动程序用于虚拟客户机中的 KVM。其提供接近裸机的性能（高达 95%）。这些驱动程序由 virtio-win 通道中的 RPM 软件包提供，也可从 Microsoft 获取（网址为 www.windowsservercatalog.com）。

    如果管理员在 RHEL 服务器上安装 virtio-win 软件包，则目录 /usr/share/virtio-win/ 将包含指向两个文件的符号链接：virtio-win-*.iso 是 CD-ROM ISO 驱动程序磁盘映像，而 virtio-drivers-*.vfd 是软盘驱动程序磁盘映像，供安装 Windows 时使用。这两个映像都可上传至 ISO 库，以便于使用。

    要将这些映像添加到 ISO 库中，您可以在手动安装 Windows 虚拟客户机之前将 virtio-drivers-*.vfd 映像附加到虚拟软盘驱动程序中。

    另外，管理员还可以将驱动程序添加到现有 Windows 虚拟客户机。首先需要将 ISO 从 RHEV-M 控制台连接到虚拟机，以便安装程序可以从 Windows 软件客户机内部使用。存在适用于 32 位和 64 位 Windows（服务器和桌面）版本的块设备和网络设备的驱动程序的安装程序：RHEV-Block/RHEV-Block64 和 RHEV-Network/RHEV-Network64。需要重新启动虚拟机，这些驱动程序才能运行，但总的说来，这是一个简单快速的过程。

    安装这些驱动程序的另一个途径是使用 /usr/share/rhev-guest-tools-iso/ 目录下 rhev-tools-setup.iso 映像提供的安装程序和 rhevm RHN 通道中的 rhev-guest-tools-iso 包提供的安装程序。如同上述文件，为使用方便，应将该 ISO 上传到 ISO 库。此安装程序还在同一软件包中提供 SPICE、USB、块和网络驱动程序，以及管理代理和 SSO（单一登录）。 
    
> 管理员需要确保在添加任何基于 virtio 的设备之前已安装了驱动程序，否则，在 Windows 下使用这些设备时可能将遇到问题。（很明显，在安装半虚拟化驱动程序之前将您的虚拟客户机系统驱动编辑为使用 virtio 不是一个好主意！） 

###### RHEV-M 虚拟客户机代理

在 RHEV-M 中创建虚拟机时，RHEV 尝试接触虚拟机以收集信息（如 IP 地址）。在 RHEV-M 尝试关闭虚拟机时，RHEV 还需要与虚拟机通信。

在 Red Hat Enterprise Linux 上，此通信通过 rhevm-guest-agent-common 软件包中的 ovirt-guest-agent 服务完成。如果在 RHEV 中安装 Red Hat Enterprise Linux 虚拟机，请确保包括 rhevm-guest-agent-common 软件包。

在 Windows 上，作为 RHEV Tools 安装的一部分来安装 RHEV 代理。 

### 为虚拟机选择控制台类型

创建或编辑虚拟机时，有两个（有时三个）不同的控制台类型选择：

*    VNC: VNC 是一项众所周知且广受支持的协议，用于连接到远程图形环境。几乎每个计算平台上都提供 VNC 客户端，但 VNC 的容量有限。例如，通过远程 VNC 连接播放视频可能无法提供最终用户寻求的平稳体验。
*    Spice:	Spice 是一个专为连接到虚拟机的控制台而开发的开放式协议。Spice 的独特功能还包括可以同时驱动四台显示器。Spice 还支持命令通道，使在客户端和连接到的虚拟机间共享 USB 设备成为可能。在性能方面，无论是在虚拟机上、系统管理程序上或者甚至是连接到虚拟机的客户端上，Spice 将动态选择 3D 渲染位置。该设计能够通过典型的办公室连接使得 Spice 客户机一次在多达四个单独的屏幕上显示流畅的全屏视频。
*    RDP: RDP 是运行 Windows 虚拟机的默认远程桌面协议。如果连接的虚拟机正在运行 Windows，RHEV 可显示使用 RDP 的虚拟机控制台，但必须先在操作系统中配置 RDP 访问且先启动 Windows。使用 RDP 时，看不到 Windows 虚拟机的启动过程。RDP 仅可作为运行 Windows 版本的虚拟机的控制台协议。

选择连接到虚拟机使用的协议应该是一个以机器为基础的决议。在大多数情况下，需要使用 Spice，但可以从编辑服务器虚拟机和运行一次对话框中更改设置。

###### Spice 协议

*    Spice 是自适应远程渲染协议，旨在提供高级别的性能，并代替 VNC 和 RDP 用于虚拟桌面环境。在连接至虚拟客户机控制台时，Spice 可以提供与登录到物理硬件时所呈现的体验几乎相同的用户体验。
*    Spice 通过自适应远程渲染解决方案实现此效果。本地 Spice 客户端旨在与图形终端的 GPU 进行通信以实现最佳的效果。如果该终端一个足够强大的视频卡，视频处理和渲染将推送到终端 GPU 并在本地执行。如果终端没有功能足够强大的视频卡，则 Spice 可能退回使用主机的 GPU，甚至进行软件渲染，但这会影响性能。然而，理想情况是将大多数图形渲染工作负载转移到其在用户的本地计算机上实现。
*    双向音频和视频允许从虚拟桌面进行 VoIP 和视频电话会议，同时，通过 USB 重定向，可以将 USB 1.0 或 2.0 设备连接到虚拟桌面。
*    实际上，qemu-kvm 为客户机操作系统提供半虚拟化 QXL 视频设备。如果客户机没有专用驱动程序，则此设备的行为方式类似基于标准 PCI、符合 VESA 的视频卡。为了完全发挥功能，客户机需要为显卡安装 QXL 驱动器。
*    对于本地图形终端，要访问虚拟机上的 Spice 控制台，最终用户可以启动跨平台 Linux/Windows 专用的 Spice 客户端，也可以使用 ActiveX（适用于 Internet Explorer）或 Mozilla 插件（适用于 Firefox）从 Web 浏览器启动客户端。请注意，客户端连接至正在运行客户机的主机，因此即使客户机处于 BSOD/崩溃状态或者无响应，也应能访问控制台。

