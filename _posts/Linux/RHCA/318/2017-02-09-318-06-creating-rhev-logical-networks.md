---
layout: post
title:  "Creating RHEV Logical Networks(318-6)"
categories: Linux
tags: RHCA 318
---

### 创建逻辑网络

###### 逻辑网络

逻辑网络是数据中心内一组指定的全局网络连接属性。当逻辑网络添加到主机时，可以使用特定于主机的网络参数来进一步配置逻辑网络。逻辑网络可以按用量、类型和要求对网络流量进行分组来优化网络流，并且允许连接和隔离。管理员可以为存储通信创建逻辑网络，以优化主机与存储域之间的网络流量；可以专门为所有虚拟机流量创建一个逻辑网络；或者创建多个逻辑网络来承载某些虚拟机组的流量。所有数据中心的默认逻辑网络是称为 rhevm 的管理网络。rhevm 网络会承载所有流量，直至创建了其他逻辑网络。对于红帽企业虚拟化管理器与主机之间的管理通信，这特别有意义。逻辑网络是数据中心级别的资源；在数据中心内创建逻辑网络时，数据中心内的群集都可以访问该网络。按需设计的逻辑网络必须在群集的所有主机中配置，然后逻辑网络才能运行。可选网络可供它们已经添加到的任何主机使用。

###### RHEV 逻辑网络

逻辑网络的隔离是基于网络的物理拓扑以及各种功能要求来完成的。不要求设置多个逻辑网络；如果管理员不想隔离流量，可允许所有网络流量使用在安装时为数据中心配置的默认网络。预定义的逻辑网络名为 rhevm，并以说明“管理网络”标记。

> 如果有任何主机正在运行，请勿更改数据中心或群集中的网络连接，因为这可能导致主机变得不可访问。 

一个逻辑网络可属于多个群集，这是多个群集中的虚拟机和节点相互通信的一种方式。每个群集进而具有不同的可用逻辑网络集。但是，所有在用的逻辑网络必须由数据中心定义。

定义逻辑网络的常见做法是让管理员创建三个逻辑网络，并设置对应的物理隔离：

*    “公共网络”连接网关路由器、RHEV-M 系统和 RHEV-H 节点。
*    “管理网络”将 RHEV-M 系统连接到 RHEV-H 节点，但不进行路由。出于安全原因，可以将管理网络限制为使用 ssh 登录。
*    “存储网络”将 RHEV-H 节点连接到 NFS 或 iSCSI 存储域，另外还连接到 RHEV-M 节点。与 NFS 和 iSCSI 不同，光纤通道存储使用 SAN（而非 IP 网络）进行通信，因此不需要单独的网络。

一个群集中的所有主机必须具有相同的网络配置。否则，虚拟机从一台主机迁移到另一台主机时将出现网络风险或通信错误。

###### 端口镜像

端口镜像会将给定逻辑网络和主机上的第 3 层网络流量复制到虚拟机上的虚拟接口。此虚拟机可用于网络调试和调整、入侵检测以及监控同一主机和逻辑网络上其他虚拟机的行为。复制的唯一流量是一台主机上一个逻辑网络的内部流量。主机外部网络上的流量并未增加；但是，与其他虚拟机相比，启用端口镜像的虚拟机会使用更多的主机 CPU 和 RAM。端口镜像需要 IPv4 IP 地址，并且不支持 Hotplugging 配置文件。从红帽企业虚拟化 3.4 开始，vNIC 配置文件中已经包含了端口镜像。当与端口镜像关联的 vNIC 配置文件附加到虚拟机时，无法变更端口镜像。要使用端口镜像，管理员需要创建一个启用了端口镜像的专用 vNIC 配置文件。

###### 必需网络、可选网络和虚拟机网络

红帽企业虚拟化 3.1 和更高版本区分必需网络和可选网络。

*    必需网络必须应用到群集中的所有主机，群集和网络才能正常运行。默认情况下，逻辑网络会作为必需网络添加到群集中。当主机的必需网络停止工作时，该主机上运行的虚拟机将迁移到其他主机；此迁移的程度取决于所选群集策略。如果管理员在某些机器上运行任务关键型工作负载，此功能很有用。当非必需网络停止工作时，网络上运行的虚拟机不会迁移到其他主机。这可以防止因大量迁移而导致不必要的 I/O 过载。
*    可选网络是指尚未明确声明为必需网络的逻辑网络。可选网络可以仅在使用这些网络的主机上实施。这些网络无论存在与否，都不会影响主机的运行状态。
*    虚拟机网络（在用户界面中称为 VM 网络）是旨在仅承载虚拟机网络流量的逻辑网络。虚拟机网络可能是必需网络，也可能是可选网络。

> 如果虚拟机在可选虚拟机网络上具有网络接口，该虚拟机将不会在没有该网络的主机上启动。

###### 管理网络的系统权限

作为 SuperUser，系统管理员可以管理管理门户的所有方面。可以为其他用户分配更具体的管理角色。当需要向用户授予管理特权，以限制他们仅访问特定资源时，这些受限管理角色非常有用。例如，DataCenterAdmin 角色的管理员特权仅适用于分配的数据中心（但该数据中心的存储例外），ClusterAdmin 的管理员特权仅适用于分配的群集。网络管理员是系统管理员角色，可以应用于特定网络，或者数据中心、群集、主机、虚拟机或模板上的所有网络。网络用户可以执行有限的管理角色，比如在特定虚拟机或模板上查看或连接网络。管理员可以使用标题栏中的配置按钮来为环境中的所有网络分配网络管理员。网络管理员角色允许执行以下操作：

*    创建、编辑和删除网络。
*    编辑网络的配置，包括配置端口镜像。
*    连接网络和从资源分离网络，包括群集和虚拟机。

> 系统会自动为创建网络的用户在该网络上分配 NetworkAdmin 权限。还可以删除现有管理员和添加新管理员来更改网络的管理员。

###### 演示：创建新的逻辑网络

1. 在 workstation 上，使用 Firefox 启动 RHEV-M 界面，然后访问 http://rhevm.podX.example.com/。单击管理门户链接。在 example.com 域中，使用 rhevadmin 用户名和 redhat 密码登录。
2. 从左侧框中，导航到系统 → 数据中心 → testdcX，然后单击网络条目。
3. 从右侧框中，单击网络选项卡，以访问数据中心的网络配置。单击新建以创建新网络。
4. 在显示的窗口中，使用以下信息来填写各字段： 

常规选项卡：
*    名称	VMNet
*    描述	VM 网络
*    VM 网络	已选中
*    MTU	默认值 (1500)

群集选项卡：

*    testcluX	已连接
*    testcluX	非必需

vNIC 配置文件 选项卡： 公共	已选中


###### 配置网络 MAC 地址池

1. 在 rhevm.podX.example.com 上打开一个终端，并查找 MAC 地址范围的 RHEV 设置：

    [root@rhevm ~]# engine-config -l | grep -i mac
    ...
    MacPoolRanges: "MAC Addresses Pool Ranges" (Value Type: String)
    ...

2. 查看当前设置。

    [root@rhevm ~]# engine-config -g MacPoolRanges
    MacPoolRanges: 00:1A:4A:01:00:00-00:1A:4A:01:00:FF version: general

    DHCP 服务器配置为根据 MAC 地址向机器提供 IP 地址。学员必须知道正确的 MAC 地址范围，才能获取其网站的正确 IP 地址。

3. 将 MAC 范围设置为 52:54:00:00:00:10-52:54:00:00:00:FF。

    [root@rhevm ~]# engine-config -s MacPoolRanges=52:54:00:00:00:10-52:54:00:00:00:FF
    [root@rhevm ~]# service ovirt-engine restart

### 将网络与 OpenStack 集成

OpenStack Neutron 作为网络提供者

OpenStack Neutron 网络目前作为技术预览提供，管理员可以将它与 RHEV 数据中心连接。Neutron 可以提供 RHEV 主机以及虚拟机所需的网络连接功能。添加 Neutron 提供者后，RHEV 便能够发现该提供者上的可用网络。管理员随后可以确定将这些网络作为新网络导入到 RHEV 数据中心，或者将网络连接到现有数据中心。另外还可以将现有 RHEV 网络导入 Neutron，从而使管理员能够通过 RHEV 来创建 Neutron 网络，而非使用 Neutron API。在创建新虚拟机时，管理员可以选择在 Neutron 网络上配置新的网络接口。使用 Neutron 作为外部网络提供者可以获得多种优势，比如将 Neutron 提供的技术用于网络，比如 IP 地址管理、L3 路由和安全组。此外，Neutron 集成利用 RHEV 中非原生支持的技术以用于 VM 网络。 

在集成 Neutron 提供者之前，管理员必须：

*    确保所有 Neutron 基础服务已配置且正在运行。
*    配置 Neutron 消息代理。
*    如果使用了 Keystone，则运行 engine-config 命令： - engine-config --set KeystoneAuthUrl=http://<host.fqdn>:35357/v2.0/
*    根据网络配置，在 RHEV-H 主机上安装 Linux 桥接工具或 Open vSwitch 工具。

以下流程说明如何添加 Neutron 外部提供者：

1. 在树形窗格中，选择外部提供者条目。
2. 单击添加按钮，以打开添加提供者窗口。
3. 输入名称和描述，然后选择 OpenStack Network 作为网络类型。
4. 单击网络插件文本字段，然后选择 Linux Bridge或 Open vSwitch，具体取决于 OpenStack 环境中设置的插件。
5. 在提供者 URL 文本字段中输入安装 OpenStack Networking 实例的机器的 URL 或全限定域名，后跟端口号。
6. （可选）选中需要身份验证复选框，并输入 OpenStack Networking 实例的凭据。管理员必须使用 Keystone 中注册的 OpenStack Networking 用户的用户名和密码。
7. 在代理配置选项卡中，填写 QPID 配置。

###### 目前的局限性和未来工作

目前的实施存在若干局限性，管理员在使用 Neutron 提供者时应考虑这些局限性：

*    同一逻辑网络可以多次导入，但仅限导入到不同数据中心。
*    如果网络由 Neutron 在外部提供，那么管理员将无法在 RHEV 中编辑该网络。要编辑外部提供者提供的逻辑网络的详细信息，管理员必须直接从提供该逻辑网络的 OpenStack Networking 实例中进行编辑。
*    对于连接到外部 Neutron 网络的虚拟 NIC，端口镜像不可用。
*    如果虚拟机使用外部提供者提供的逻辑网络，那么仍有虚拟机在使用该逻辑网络时，无法从管理器中删除该提供者。
*    外部提供者提供的网络不是必需网络。因此，在主机选择期间，针对已导入此类逻辑网络的群集进行调度不会将这些逻辑网络考虑在内。此外，用户应负责确保逻辑网络在已导入此类逻辑网络的群集中主机上可用。

下一个 Neutron 支持实现将包括：

*    IPAM 支持。
*    更好的安全组支持。
*    管理员将能够使用 RHEV-M 来删除 Neutron 网络。
*    管理员将能够看到 Neutron 子网，从而能够管理这些子网。
*    高级功能（比如 VPN 即服务和负载均衡即服务）将可用。
